---
title: åçˆ¬è™«ç³»åˆ—ä¹‹8ï¼šcloudflareé˜²çˆ¬æ–¹æ¡ˆ
date: 2019-09-04 15:46:11
tags: [çˆ¬è™«]
categories: [çˆ¬è™«]
keywords: [çˆ¬è™«]
description: æ¨é…·çˆ¬è™«è¿˜æ˜¯ç»§ç»­éæ³•çˆ¬å–æœ¬ç«™ã€‚cloudflareé˜²ç«å¢™ç­–ç•¥ï¼Œæ‹¦æˆªçˆ¬è™«ã€‚
---

# åˆæ˜¯æ¨é…·çˆ¬è™«

ä¸å¹¸çš„æ¶ˆæ¯ï¼Œæ¨é…·çˆ¬è™«åˆæ¥äº†ã€‚
{% asset_img tuicool-crawler.png æ¨é…·çˆ¬è™« %}

æ‰“å¼€htmlï¼Œå‘ç°å­—ä½“åçˆ¬å·²ç»è¢«ç ´ğŸ˜­ï¼Œç›´æ¥è§£æä¸ºæ–‡å­—äº†ï¼š
{% asset_img font-crack.png å­—ä½“åçˆ¬è¢«ç ´ %}

ä¸è¿‡å›¾ç‰‡ä¿æŠ¤è¿˜èƒ½ç”¨ã€‚
{% asset_img protect-image-url.png å›¾ç‰‡ä¿æŠ¤ %}

å¦å¤–ï¼Œè‡³ä»Šæ¨é…·å®˜æ–¹é‚®ä»¶biz@tuicool.comä¸€ç›´æ²¡æœ‰å›å¤ã€‚

<!-- more -->

ç°åœ¨çš„ç»“è®ºæ˜¯ï¼š
- æ¨é…·çˆ¬è™«å¯¹æˆ‘çš„å°ç«™åº”è¯¥æ˜¯ä¸€å‘¨æ›´æ–°ä¸€æ¬¡ã€‚
- æ–‡ç« é“¾æ¥è¿˜æ˜¯æš´éœ²ã€‚çŒœæµ‹æ˜¯ä»é¦–é¡µéå†ã€‚
- ç®€å•çš„ä¸€å¥—è½¬æ¢å­—ä½“æ˜ å°„åçš„æ–¹å¼ï¼Œä¸ä¿é™©ã€‚

ä½ä¼°äº†è¿™ä¸ªå¤šå¹´æ–‡ç« æ¬è¿å·¥ã€‚

åº”å¯¹æªæ–½ï¼š
- å…ˆæŠŠè¿˜æ²¡è¢«çˆ¬çš„æ–‡ç« æ’¤ä¸‹
- ä¹°äº†æ–°åŸŸåï¼Œèµ¶ç´§æå¤‡æ¡ˆã€‚ç›´æ¥nginx + iptableså°æ€


# cloudflare é˜²ç«å¢™ç­–ç•¥é˜²çˆ¬

æ›´æ–°äº2019.9.6ï¼š
åœ¨é˜¿é‡Œäº‘ä¹°äº†åŸŸåä¹‹åï¼Œå‘ç°å¤‡æ¡ˆè¦æ±‚ç»­è´¹ä¸»æœºè‡³å°‘3ä¸ªæœˆä»¥ä¸Šã€‚ã€‚ã€‚å¦‚æœä½¿ç”¨å¦ä¸€ä¸ªå¼€å‘è´¦å·çš„ECSå»å¤‡æ¡ˆï¼Œåˆæ¶‰åŠåˆ°å¤‡æ¡ˆäººå’ŒåŸŸåæŒæœ‰äººçš„é—®é¢˜ã€‚

åŸŸåå’Œå¤‡æ¡ˆï¼Œåªæ˜¯ä¸ºäº†èƒ½åœ¨ecsä¸Šéƒ¨ç½²ç«™ç‚¹ï¼Œå¹¶ä¸”ä½¿ç”¨nginxåšwafã€‚
å¦‚æœæœ‰å¦å¤–çš„æ–¹å¼èƒ½å¤Ÿå®ç°wafï¼Œå°±å¯ä»¥é˜²çˆ¬ï¼Œä¸éœ€è¦è¿™ä¹ˆæŠ˜è…¾ã€‚
æœç´¢èµ„æ–™ï¼Œå‘ç°cloudflareæä¾›äº†ä¸€äº›wafåŠŸèƒ½ã€‚
äºæ˜¯æ–°çš„æ–¹æ¡ˆå‡ºæ¥ï¼š
1. ç™»å½•é˜¿é‡Œäº‘åŸŸåæ§åˆ¶å°ï¼Œæ–°åŸŸå`ycwu314.top`åŸŸåè§£æä»ä¸‡ç½‘ï¼Œæ”¹ä¸ºcloudflare nameserverã€‚
```
ines.ns.cloudflare.com
ivan.ns.cloudflare.com
```

2. dnsè§£æè½¬ç§»ï¼Œè¦ç­‰å¾…ä¸€æ®µæ—¶é—´æ‰ç”Ÿæ•ˆã€‚
```
# whois ycwu314.top | grep 'Name Server'
Name Server: ines.ns.cloudflare.com
Name Server: ivan.ns.cloudflare.com
```

3. åœ¨cloudflareä¸­å¢åŠ Aè®°å½•æˆ–è€…CNAMEï¼ŒæŒ‡å‘githubã€‚
>Custom domains configured with A records
>If you configured your custom domain using an A record, your A record must point to one of the following IP addresses for HTTPS to work:
>
>185.199.108.153
>185.199.109.153
>185.199.110.153
>185.199.111.153

4. GitHub pagesæŒ‡å‘æ–°çš„åŸŸå`ycwu314.top`ã€‚

5. å¼€å¯httpsã€‚cfé»˜è®¤ç»™ç«™ç‚¹æä¾›äº†å…è´¹è¯ä¹¦ï¼Œå¹¶ä¸”å¼€å¯äº†httpsï¼Œä¹Ÿæ”¯æŒå¼ºåˆ¶httpsä¼ è¾“ã€hstsç­‰ç‰¹æ€§ã€‚

6. åœ¨cfä¸­é…ç½®waf
{% asset_img cloudflare-firewall.png cloudflareé˜²ç«å¢™ %}
çº³å°¼ï¼Œè¦ä»˜è´¹ç”¨æˆ·æ‰èƒ½ä½¿ç”¨ã€‚ã€‚ã€‚å…¶å®æœ‰éš”å£çš„å…¥å£æ˜¯å…è´¹çš„ï¼Œå¯ä»¥é…ç½®5æ¡è§„åˆ™
{% asset_img cloudflare-firewall-2.png cloudflareé˜²ç«å¢™ %}


ä½¿ç”¨github pagesè‡ªå®šä¹‰åŸŸåçš„å¦ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œç”±githubç›´æ¥è¿”å›301åšé‡å®šå‘ï¼ŒåŠ å¿«googleç´¢å¼•è½¬ç§»æƒé‡ã€‚

# è§£å†³cloudflare access log é—®é¢˜

æ‹¦æˆªçˆ¬è™«è¯·æ±‚ï¼Œå¯ä»¥æ ¹æ®ipã€user-agentæ‹¦æˆªï¼Œé€šå¸¸æ˜¯åœ¨nginx/apacheçš„access logè·å–ã€‚
ä½†æ˜¯ï¼Œcloudflareåªæœ‰ä¼ä¸šç‰ˆç”¨æˆ·æ‰èƒ½è·å–ï¼ˆäººæ°‘å¸ç©å®¶ğŸ˜‚ï¼‰ã€‚
ä¸è¿‡æˆ‘æƒ³åˆ°ä¸€ä¸ªæ–¹æ³•ï¼Œå¢åŠ ä¸€ä¸ªé˜²ç«å¢™ruleï¼Œç”¨äºè®°å½•access logã€‚
å†ä»è¿™ä¸ªruleè§‚å¯Ÿå¯ç–‘çš„ipå’Œuser-agentã€‚

åœ¨firewallã€toolsè¿™ä¸ªå…¥å£ä¹Ÿå¯ä»¥é…ç½®ipã€user-agentæ‹¦æˆªï¼Œä½†æ˜¯åªèƒ½ä¸€ä¸ªä¸€ä¸ªæ·»åŠ ã€‚
{% asset_img cloudflare-firewall-tools.png cloudflareé˜²ç«å¢™ %}

Firewall Rulesé¡µé¢å¯ä»¥ä½¿ç”¨cfçš„è¯­æ³•ï¼Œç»“åˆè„šæœ¬ç”Ÿæˆæ‹¦æˆªè§„åˆ™ã€‚ä½†æ˜¯ç”Ÿæˆçš„cfè¡¨è¾¾å¼è¦å°äº4KBï¼Œå› æ­¤UAä¸èƒ½æ— é™é…ç½®ã€‚å…·ä½“è¯­æ³•ä½¿ç”¨å¾ˆç®€å•ï¼Œçœ‹ä¸‹å®˜ç½‘ä»‹ç»å°±å¯ä»¥äº†ã€‚
{% asset_img cloudflare-firewall-result.png cloudflareé˜²ç«å¢™ %}

æœ€å¤§é—®é¢˜æ˜¯ä¸æ”¯æŒä¸‹è½½access logï¼Œç›®å‰åªèƒ½äººå·¥çœ‹å’Œåˆ†æã€‚ä»¥åå†™ä¸ªè„šæœ¬ï¼Œç›´æ¥æå–access logæ—¥å¿—ï¼Œæ–¹ä¾¿åšè¡Œä¸ºåˆ†æã€‚

å¦å¤–ï¼Œä½¿ç”¨cloudflareä¹‹åï¼Œé€Ÿåº¦æ¯”ç›´è¿github pageè¦æ…¢ä¸€äº›ã€‚


# logflare.app

ç ”ç©¶cloudflareåŠŸèƒ½çš„æ—¶å€™åœ¨appé¡µé¢å‘ç°äº†å¥½ä¸œè¥¿ï¼šlogflare.appã€‚
{% asset_img logflare-1.png logflare.app %}
logflareä½¿ç”¨cloudflare workerï¼ˆserverlessåº”ç”¨ï¼‰ï¼Œå¼‚æ­¥é‡‡é›†è¯·æ±‚æ—¥å¿—ï¼Œä¸å¯¹é¡µé¢è¯·æ±‚å‘ç”Ÿå½±å“ã€‚
logflare.appæ”¶é›†è¯·æ±‚æ—¥å¿—ï¼Œå¹¶ä¸”å’ŒGoogle Data Studioé›†æˆã€‚è¿™å°±æ˜¯æˆ‘æƒ³è¦çš„access logï¼Œè¿˜æœ‰æ•°æ®åˆ†æå·¥å…·å¯ä»¥ä½¿ç”¨ï¼Œå¤ªèµäº†ï¼
{% asset_img logflare-2.png logflare.app %}
ä¸è¿‡åªæœ‰IPåœ°å€ï¼Œæ²¡æœ‰åœ°ç†ä¿¡æ¯ï¼Œå¯ä»¥å»IPInfo.ioæ³¨å†Œä¸€ä¸ªkeyï¼Œfree planä¸€ä¸ªæœˆ5w requestsã€‚


# æ•æ‰çˆ¬è™«

å‰©ä¸‹çš„å°±æ˜¯å‘å‡ ç¯‡å ä½ç¬¦æ–‡ç« ï¼Œå°è¯•æ•æ‰æ¨é…·çˆ¬è™«äº†ã€‚

# github pages è‡ªå®šä¹‰åŸŸåè®¾ç½®ä¸¢å¤±

ä½¿ç”¨travis ciæ„å»ºåï¼Œå‘ç°GitHub pagesè®¾ç½®çš„è‡ªå®šä¹‰åŸŸåæ²¡äº†ã€‚
æ”¹ä¸ºä½¿ç”¨CNAMEæ–‡ä»¶ï¼Œè¿˜æ˜¯æ²¡æœ‰ç”Ÿæ•ˆã€‚
å‘ç°17å¹´çš„æ—¶å€™å°±æœ‰äººæ±‡æŠ¥äº†è¿™ä¸ªé—®é¢˜ï¼š[Pushing changes to GitHub Pages branch removes custom domain setting #7538](https://github.com/travis-ci/travis-ci/issues/7538)ã€‚
travis ciå®˜ç½‘fqdné€‰é¡¹ï¼š[deployment](https://docs.travis-ci.com/user/deployment/pages/)
```
deploy:
    - fqdn: Optional, sets a custom domain for your website, defaults to no custom domain support.
```
ç„¶è€Œä¹Ÿæ²¡æœ‰ç”¨ã€‚
å› ä¸ºdeployæ˜¯ä½¿ç”¨hexo då‘½ä»¤æ“ä½œçš„ã€‚å¹¶étravis ciçš„deployä»»åŠ¡ã€‚
åæ¥æƒ³èµ·æ¥ï¼Œæˆ‘æ˜¯åœ¨æºç ç›®å½•å»ºç«‹çš„CNAMEæ–‡ä»¶ï¼Œæ„å»ºå®Œä¹‹åå½“ç„¶æ²¡æœ‰æ‹·è´åˆ°masteråˆ†æ”¯çš„æ ¹ç›®å½•ã€‚
å› ä¸ºä½¿ç”¨äº†nextä¸»é¢˜ï¼Œç›´æ¥æŠŠCNAMEæ–‡ä»¶ä¸¢åˆ°`themes\next\source`ã€‚

# åç»­æ›´æ–°

## å±è”½IDCæœºæˆ¿ã€xxxäº‘

æ›´æ–°äº2019.9.10ï¼š
ç»è¿‡å‡ å¤©çš„è§‚å¯Ÿï¼Œå±è”½äº†ä¸€äº›IDCæœºæˆ¿ã€xxxäº‘ã€ç–‘ä¼¼ä»£ç†çš„ipã€‚åæ¥ipå¤ªå¤šï¼Œç”¨Cæ®µåœ°å€å±è”½ä¹Ÿéº»çƒ¦ï¼Œå¯¹äºIDCæœºæˆ¿åœ°å€ï¼Œç›´æ¥å±è”½ASNã€‚ç”¨åˆ°3ä¸ªå·¥å…·ï¼š
1. æ ¹æ®åå­—æˆ–è€…asnæŸ¥æ‰¾
https://hackertarget.com/as-ip-lookup/
è¾“å…¥idcã€cloudä¹‹ç±»å…³é”®å­—å¾—åˆ°ä¸€äº›asnã€‚

2. æ ¹æ®asnæŸ¥æ‰¾ipæ®µ
https://traceroute-online.com/ip-asn-lookup/

3. ipåœ°å€æŸ¥è¯¢ï¼ŒåŒ…æ‹¬asnã€idcæœºæˆ¿ç­‰
https://www.ipip.net/ip.html

å°å¿ƒéª¨å¹²ç½‘çš„asnï¼Œä¸è¦æ‰‹æŠ–å±è”½ğŸ˜€ã€‚ä¸»è¦å±è”½äº‘ä¸»æœºå‚å•†çš„asnå°±å¯ä»¥ã€‚

æ¯”è¾ƒéš¾å¯¹ä»˜çš„æ˜¯ä»£ç†ipï¼Œåªèƒ½è§ä¸€ä¸ªå°ä¸€ä¸ªã€‚

## å›½å¤–æœºæˆ¿çš„çˆ¬è™«

é™¤äº†å›½å†…å‡ å¤§äº‘å‚å•†å¤–ï¼Œçˆ¬è™«ç«™ç‚¹è¿˜ä½¿ç”¨äº†å›½å¤–ï¼Œç»Ÿè®¡ä¸‹æ¥æ³•å›½ã€ä¿„ç½—æ–¯çš„æœºæˆ¿è¯·æ±‚æ™®éå¯ç–‘ï¼Œç›´æ¥å¢åŠ ä¸€ä¸ªè§„åˆ™ï¼Œå¯¹å›½å®¶çº§åˆ«æ‹¦æˆªå¹¶ä¸”å¼¹å‡ºéªŒè¯ç 
```
ip.geoip.country in {"RU" "FR"}
```

## atom.xmlå’Œç«™ç‚¹æ ¹ç›®å½•

ä¹‹å‰çŒœæµ‹ï¼Œç«™ç‚¹é“¾æ¥æ³„éœ²ï¼Œæ˜¯é¦–é¡µã€atom.xmlã€sitemapã€å½’æ¡£é¡µé¢ã€‚
äºæ˜¯åŠ äº†è§„åˆ™è§‚å¯Ÿè¿™äº›åœ°å€ã€‚æœ€åå‘ç°/atom.xmlå’Œç«™ç‚¹æ ¹ç›®å½•æ˜¯é‡ç¾åŒºï¼š
{% asset_img çˆ¬è™«åˆ†æ.png çˆ¬è™«åˆ†æ %}
è¿™ç§åœ¨ä¸€ä¸ªäº‘å¹³å°çŸ­æ—¶é—´æ›´æ¢ipï¼ˆå›½å†…ã€æ—¥æœ¬ç­‰ï¼Œè§‚å¯ŸASNï¼‰åå¤æŸ¥è¯¢/atom.xmlã€/çš„åœ°å€ï¼ŒåŸºæœ¬æ˜¯çˆ¬è™«ã€‚
å¦å¤–ï¼Œlinuxæ¡Œé¢ç«¯æ¯”ä¾‹å¾ˆå°‘ï¼Œuser agentå¸¦æœ‰â€œLinux x86_x64â€å¾ˆæœ‰å¯èƒ½æ˜¯çˆ¬è™«ã€‚

## çˆ¬è™«æ–°æ‰‹

ä¸è¦ä»¥ä¸ºè¿™å¹´å¤´åšçˆ¬è™«çš„éƒ½ä¼šæ”¹ä¸ªuser-agent
{% asset_img go-http-client.png go-http-client %}
{% asset_img empty-ua.png "empty user agent" %}
{% asset_img GuzzleHttp.png GuzzleHttp %}
è¯è¯´è¿™æ˜¯å¾ˆæ—©ä¹‹å‰æš´éœ²çš„å›¾ç‰‡åœ°å€ï¼Œæ—©å°±æ¢é“¾æ¥äº†ã€‚è‚¯å®šæ˜¯çˆ¬äº†å¦ä¸€ä¸ªç½‘ç«™ï¼Œæ°å¥½åˆæ˜¯çˆ¬äº†ä¹‹å‰æˆ‘çš„æ–‡ç« ã€‚
é¡ºå¸¦åˆå±è”½äº†ä¸€ä¸ªidcã€‚

åˆçº§çˆ¬è™«æœ€å¤§çš„å±å®³æ˜¯ä¸é™é€Ÿã€‚åˆ†åˆ†é’Ÿå¯ä»¥æ‹–å®åŸç«™ç‚¹
{% asset_img åˆçº§çˆ¬è™«-1.png "åˆçº§çˆ¬è™«æœ€å¤§çš„å±å®³æ˜¯ä¸é™é€Ÿ" %}
è¿™æ˜¯æ˜¯å¾ˆä¹…ä»¥å‰æš´éœ²å‡ºå»çš„é“¾æ¥äº†ã€‚æ‰“å¼€è¯¦æƒ…ï¼ŒåŸæ¥æ˜¯wordpressé‡‡é›†æ’ä»¶ã€‚
{% asset_img åˆçº§çˆ¬è™«-2.png "åˆçº§çˆ¬è™«" %}
æˆ‘çš„ç­–ç•¥æ˜¯block IPä¼˜å…ˆï¼Œå¹¶ä¸”åŒ…æ‹¬å‡ ä¸ªå¸¸è§äº‘æœåŠ¡IDCçš„ASNï¼Œå› æ­¤é¡¶ä½äº†ã€‚
é¡ºä¾¿block UAç­–ç•¥ä¹Ÿæ›´æ–°äº†ã€‚

## é‡åˆ°é«˜çº§çˆ¬è™«

æœ‰çš„çˆ¬è™«æ¯”è¾ƒé«˜çº§ã€‚å•ä¸ªipè®¿é—®é¢‘æ¬¡å¾ˆä½ï¼Œå¹¶ä¸”æ˜¯ä½¿ç”¨æœªè¢«å‘ç°çš„ä»£ç†ipã€‚
ä½†æ˜¯ç”±äºè®¿é—®æ—¶é—´é—´éš”å¤ªé•¿åè€Œæš´éœ²äº†ã€‚
ä¸€ç¯‡çŸ­æ–‡ç« ï¼Œæœ‰å‡ å¼ å›¾ï¼Œæ­£å¸¸äººé˜…è¯»ä¸¤ä¸‰åˆ†é’Ÿå°±è¯»å®Œäº†ï¼Œä½†æ˜¯å›¾ç‰‡çš„åœ°å€å´æ˜¯é—´éš”5ã€6åˆ†é’Ÿæ‰ä¸‹è½½ä¸€å¼ ã€‚
å¯¹äºè¿™ç§ç±»å‹çš„çˆ¬è™«ï¼Œé™æ€çš„wafæ˜¯å¾ˆéš¾é˜²ä½çš„ã€‚åªèƒ½æ ¹æ®æ–‡ç« ç‰¹å¾å’Œè®¿é—®è¡Œä¸ºç‰¹å¾åšå»ºæ¨¡ğŸ˜‚

## å›¾ç‰‡ä¿æŠ¤

cloudflareæ”¯æŒå›¾ç‰‡ä¿æŠ¤ï¼ˆrefereræ£€æŸ¥ï¼‰ï¼Œå…·ä½“åŠŸèƒ½å«â€œHotlink Protectionâ€ï¼š
>Protect your images from off-site linking.
>Supported file extensions: gif, ico, jpg, jpeg, and png.

æ³¨æ„æš‚æ—¶ä¸æ”¯æŒwebpï¼Œè½åäº†ã€‚ä»¥åå›¾ç‰‡ä¼˜å…ˆä½¿ç”¨pngã€‚

## æ•ˆæœ

è·ç¦»ä¸Šæ¬¡è¢«çˆ¬å–10å¤©äº†
{% asset_img anti-tuicool.png anti-tuicool %}
