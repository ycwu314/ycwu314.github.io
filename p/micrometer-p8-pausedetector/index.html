<!-- build time:Thu Dec 24 2020 16:28:37 GMT+0800 (China Standard Time) --><!DOCTYPE html><html class="theme-next mist use-motion" lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="keywords" content="java,微服务,分布式系统,架构设计"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.6/jquery.fancybox.min.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.2/css/font-awesome.min.css"><link rel="stylesheet" href="/css/main.css?v=7.1.2"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.2"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.2"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.2"><link rel="mask-icon" href="/images/logo.svg?v=7.1.2" color="#222"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",version:"7.1.2",sidebar:{position:"left",display:"hide",offset:12,onmobile:!1,dimmer:!1},back2top:!0,back2top_sidebar:!1,fancybox:!0,fastclick:!1,lazyload:!1,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta name="description" content="PauseDetector负责检查暂停，并通知线程。"><meta name="keywords" content="micrometer pausedetetor,LatencyUtils"><meta property="og:type" content="article"><meta property="og:title" content="micrometer 系列 8： PauseDetector 以及 LatencyUtils"><meta property="og:url" content="https://ycwu314.cloud/p/micrometer-p8-pausedetector/index.html"><meta property="og:site_name" content="ycwu314"><meta property="og:description" content="PauseDetector负责检查暂停，并通知线程。"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://ycwu314.cloud/p/micrometer-p8-pausedetector/v2_micrometer-pausedector.png"><meta property="og:updated_time" content="2020-12-24T08:27:14.352Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="micrometer 系列 8： PauseDetector 以及 LatencyUtils"><meta name="twitter:description" content="PauseDetector负责检查暂停，并通知线程。"><meta name="twitter:image" content="https://ycwu314.cloud/p/micrometer-p8-pausedetector/v2_micrometer-pausedector.png"><link rel="canonical" href="https://ycwu314.cloud/p/micrometer-p8-pausedetector/"><script id="page.configurations">CONFIG.page={sidebar:""}</script><title>micrometer 系列 8： PauseDetector 以及 LatencyUtils | ycwu314</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">ycwu314</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">潮的工地</h1></div><div class="site-nav-toggle"><button aria-label="切换导航栏"><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-collection"><a href="/collection" rel="section"><i class="menu-item-icon fa fa-fw fa-file-code-o"></i><br>专题</a></li><li class="menu-item menu-item-tags"><a href="/t/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://ycwu314.cloud/p/micrometer-p8-pausedetector/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="ycwu314"><meta itemprop="description" content="java, 微服务, 分布式系统, 架构设计"><meta itemprop="image" content="/images/avatar.webp"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="ycwu314"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">micrometer 系列 8： PauseDetector 以及 LatencyUtils</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-03-10 10:56:45" itemprop="dateCreated datePublished" datetime="2020-03-10T10:56:45+08:00">2020-03-10</time> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2020-12-24 16:27:14" itemprop="dateModified" datetime="2020-12-24T16:27:14+08:00">2020-12-24</time> </span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/c/监控/" itemprop="url" rel="index"><span itemprop="name">监控</span></a></span></span><br><span title="post.wordcount">共&nbsp;923&nbsp;字 <span class="post-meta-divider">|</span> </span><span title="post.min2read">阅读时间&nbsp;4&nbsp;分钟</span><div class="post-description">PauseDetector负责检查暂停，并通知线程。</div></div></header><div class="post-body" itemprop="articleBody"><p style="text-align:center;font-size:14px">本文作者ycwu314，未经允许请勿转载 <a href="https://ycwu314.cloud/p/micrometer-p8-pausedetector/">micrometer 系列 8： PauseDetector 以及 LatencyUtils</a> : https://ycwu314.cloud/p/micrometer-p8-pausedetector/<br>&#x6E29;&#x99A8;&#x63D0;&#x793A;&#xFF1A;&#x5982;&#x679C;&#x4E0D;&#x662F;&#x5728;&#x8FD9;&#x4E9B;&#x5730;&#x65B9;&#x770B;&#x5230;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#xFF0C;&#x90A3;&#x4E48;&#x4F60;&#x53EF;&#x80FD;&#x662F;&#x722C;&#x866B;&#x6587;&#x7AE0;&#x7684;&#x53D7;&#x5BB3;&#x8005;&#xFF1A;<br>https://ycwu314.top/ (原https://ycwu314.github.io/)<br>&#x672A;&#x7ECF;&#x6388;&#x6743;&#x7684;&#x8F6C;&#x8F7D;&#xFF0C;&#x4E0D;&#x4EC5;&#x6253;&#x51FB;&#x539F;&#x521B;&#x79EF;&#x6781;&#x6027;&#xFF0C;&#x8FD8;&#x83B7;&#x53D6;&#x4E0D;&#x5230;&#x6700;&#x65B0;&#x7684;&#x6587;&#x7AE0;&#x66F4;&#x65B0;&#x4FE1;&#x606F;&#x3002;</p><h1 id="背景"><a href="# 背景" class="headerlink" title="背景"></a>背景</h1><p>之前在 <code>AbstractTimer</code> 源码第一次接触到 <code>PauseDetector</code>，下面是调研笔记。</p><a id="more"></a><h1 id="why-latency"><a href="#why-latency" class="headerlink" title="why latency ?"></a>why latency ?</h1><p>复制粘贴自 latencyutils 官网，解释为什么需要暂停统计追踪：</p><blockquote><ul><li>When a pause occurs during a tracked operation, a single long recorded latency will appear in the recorded values, with no long latencies associated with any pending requests that may be stalled by the pause.</li><li>When a pause occurs outside of the tracked operation (and outside of the tracked time window) no long latency value would be recorded, even though any requested operation would be stalled by the pause.</li></ul></blockquote><p>翻译过来，大概是：</p><ul><li>当在跟踪操作期间发生暂停时，记录的值中将出现一个长记录的延迟，那么后续挂起的请求不会被关联到长延迟。</li><li>当在跟踪的操作之外（以及在跟踪的时间窗口之外）发生暂停时，也不会记录长时间的延迟值。</li></ul><p>有了暂停跟踪，能够对被测量操作获取更加精确的耗时统计。</p><h1 id="PauseDetector 体系"><a href="#PauseDetector 体系" class="headerlink" title="PauseDetector 体系"></a>PauseDetector 体系</h1><p>在 micrometer 中，使用 PauseDetector 包装延迟统计的实现。</p><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="/p/micrometer-p8-pausedetector/v2_micrometer-pausedector.png" title="micrometer-pausedector"><p>因为暂停统计会带来性能上的 overhead，所以新版 micrometer 默认实现是 <code>NoPauseDetector</code>。</p><p><code>ClockDriftPauseDetector</code> 是另一个实现，考虑到时钟漂移：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClockDriftPauseDetector</span> <span class="keyword">implements</span> <span class="title">PauseDetector</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Duration sleepInterval;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Duration pauseThreshold;</span><br></pre></td></tr></table></figure></div><p>嗯，然而并没看出什么神奇地方，只是携带 sleepInterval 和 pauseThreshold 两个参数而已。</p><p>真正应用 PauseDetector 是在 <code>AbstractTimer</code> 的实现中：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;PauseDetector, org.LatencyUtils.PauseDetector&gt; pauseDetectorCache =</span><br><span class="line">            <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initPauseDetector</span><span class="params">(PauseDetector pauseDetectorType)</span> </span>&#123;</span><br><span class="line">        pauseDetector = pauseDetectorCache.computeIfAbsent(pauseDetectorType, detector -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (detector <span class="keyword">instanceof</span> ClockDriftPauseDetector) &#123;</span><br><span class="line">                ClockDriftPauseDetector clockDriftPauseDetector = (ClockDriftPauseDetector) detector;</span><br><span class="line">                <span class="comment">// 底层实现是 SimplePauseDetector， 来自 LatencyUtils 工具包 </span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> SimplePauseDetector(clockDriftPauseDetector.getSleepInterval().toNanos(),</span><br><span class="line">                        clockDriftPauseDetector.getPauseThreshold().toNanos(), <span class="number">1</span>, <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pauseDetector <span class="keyword">instanceof</span> SimplePauseDetector) &#123;</span><br><span class="line">            <span class="keyword">this</span>.intervalEstimator = <span class="keyword">new</span> TimeCappedMovingAverageIntervalEstimator(<span class="number">128</span>,</span><br><span class="line">                    <span class="number">10000000000L</span>, pauseDetector);</span><br><span class="line"></span><br><span class="line">            pauseDetector.addListener((pauseLength, pauseEndTime) -&gt; &#123;</span><br><span class="line"><span class="comment">//            System.out.println("Pause of length" + (pauseLength / 1e6) + "ms, end time" + pauseEndTime);</span></span><br><span class="line">                <span class="keyword">if</span> (intervalEstimator != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 间隔区间</span></span><br><span class="line">                    <span class="keyword">long</span> estimatedInterval = intervalEstimator.getEstimatedInterval(pauseEndTime);</span><br><span class="line">                    <span class="keyword">long</span> observedLatencyMinbar = pauseLength - estimatedInterval;</span><br><span class="line">                    <span class="keyword">if</span> (observedLatencyMinbar &gt;= estimatedInterval) &#123;</span><br><span class="line">                        recordValueWithExpectedInterval(observedLatencyMinbar, estimatedInterval);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div><h1 id="SimplePauseDetector"><a href="#SimplePauseDetector" class="headerlink" title="SimplePauseDetector"></a>SimplePauseDetector</h1><p>LatencyUtils 是一个暂停统计追踪开发包，提供了 SimplePauseDetector 等工具实现。<br>SimplePauseDetector 通过一组线程检测是否发生了暂停，以及监听器机制（<code>PauseDetectorListener</code>）通知调用方发生了 pause。</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="JAVA"><figure class="iseeu highlight /java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimplePauseDetector</span> <span class="keyword">extends</span> <span class="title">PauseDetector</span> </span>&#123;</span><br><span class="line">    <span class="comment">// consensus time： 共识时间</span></span><br><span class="line">    <span class="comment">// 结合 CAS 操作解决多个检测线程的并发安全</span></span><br><span class="line">    <span class="keyword">final</span> AtomicLong consensusLatestTime = <span class="keyword">new</span> AtomicLong();</span><br><span class="line">    <span class="comment">// 检查线程，最多 64 个</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SimplePauseDetectorThread detectors[];</span><br><span class="line">    <span class="comment">// 挂起 detector 线程的标记位</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> stallThreadMask = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> stopThreadMask = <span class="number">0</span>;    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">SimplePauseDetectorThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        <span class="keyword">volatile</span> <span class="keyword">long</span> observedLasUpdateTime;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> threadNumber;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> threadMask;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 省略构造函数</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">long</span> shortestObservedTimeAroundLoop = Long.MAX_VALUE;</span><br><span class="line"></span><br><span class="line">            observedLasUpdateTime = consensusLatestTime.get();</span><br><span class="line">            <span class="keyword">long</span> now = TimeServices.nanoTime();</span><br><span class="line">            <span class="keyword">long</span> prevNow = now;</span><br><span class="line">            <span class="comment">// 初始化共识时间</span></span><br><span class="line">            consensusLatestTime.compareAndSet(observedLasUpdateTime, now);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> ((stopThreadMask &amp; threadMask) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (sleepInterval != <span class="number">0</span>) &#123;</span><br><span class="line">                    TimeServices.sleepNanos(sleepInterval);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 外部调用明确要挂起该检测线程，则自旋等待</span></span><br><span class="line">                <span class="comment">// This is ***TEST FUNCTIONALITY***: Spin as long as we are externally asked to stall:</span></span><br><span class="line">                <span class="keyword">while</span> ((stallThreadMask &amp; threadMask) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                observedLasUpdateTime = consensusLatestTime.get();</span><br><span class="line">                <span class="comment">// Volatile store above makes sure new "now" is measured after observedLasUpdateTime sample</span></span><br><span class="line">                now = TimeServices.nanoTime();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Track shortest time around loop:</span></span><br><span class="line">                shortestObservedTimeAroundLoop = Math.min(now - prevNow, shortestObservedTimeAroundLoop);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Update consensus time as long as it is is the past:</span></span><br><span class="line">                <span class="comment">// 这里考虑多线程环境 / 上下文切换等场景导致 observedLasUpdateTime 可能大于 now</span></span><br><span class="line">                <span class="keyword">while</span> (now &gt; observedLasUpdateTime) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (consensusLatestTime.compareAndSet(observedLasUpdateTime, now)) &#123;</span><br><span class="line">                        <span class="comment">// Successfully and atomically moved consensus time forward. Act on the known delta:</span></span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">long</span> deltaTimeNs = now - observedLasUpdateTime;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// Calculate hiccup time (accounting for known time around loop):</span></span><br><span class="line">                        <span class="keyword">long</span> hiccupTime = Math.max(deltaTimeNs - shortestObservedTimeAroundLoop, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 超过暂停阈值才通知监听器</span></span><br><span class="line">                        <span class="keyword">if</span> (hiccupTime &gt; pauseNotificationThreshold) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (verbose) &#123;</span><br><span class="line">                                System.out.println(<span class="string">"SimplePauseDetector thread"</span> + threadNumber +</span><br><span class="line">                                        <span class="string">": sending pause notification message: pause of"</span> + hiccupTime +</span><br><span class="line">                                        <span class="string">"nsec detected at nanoTime:"</span> + now);</span><br><span class="line">                            &#125;</span><br><span class="line">                            </span><br><span class="line">                            notifyListeners(hiccupTime, now);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// Failed to atomically move consensus time forward. Try again with current value:</span></span><br><span class="line">                        observedLasUpdateTime = consensusLatestTime.get();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                prevNow = now;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (verbose) &#123;</span><br><span class="line">                System.out.println(<span class="string">"SimplePauseDetector thread"</span> + threadNumber + <span class="string">"terminating..."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div><h1 id="IntervalEstimator"><a href="#IntervalEstimator" class="headerlink" title="IntervalEstimator"></a>IntervalEstimator</h1><p><code>AbstractTimer</code> 在配置 PauseDetector 时候，还要指定间隔估算器。</p><p>TODO：</p><ul><li>MovingAverageIntervalEstimator</li><li>TimeCappedMovingAverageIntervalEstimator</li></ul><p>以后继续深入。</p><h1 id="参考"><a href="# 参考" class="headerlink" title="参考"></a>参考</h1><ul><li><a href="http://latencyutils.org/" rel="external nofollow noopener noreferrer" target="_blank">LatencyUtils: A latency stats tracking package.</a></li><li><a href="http://highscalability.com/blog/2015/10/5/your-load-generator-is-probably-lying-to-you-take-the-red-pi.html;jsessionid=665DE20AE37DDF42236EC0BEC9FC6313.v5-web006" rel="external nofollow noopener noreferrer" target="_blank">Your Load Generator Is Probably Lying To You - Take The Red Pill And Find Out Why</a></li></ul><h1>题外话</h1><p style="text-align:center;font-size:14px">&#x672C;&#x6587;&#x4F5C;&#x8005;ycwu314，&#x672A;&#x7ECF;&#x5141;&#x8BB8;&#x8BF7;&#x52FF;&#x8F6C;&#x8F7D; <a href="https://ycwu314.cloud/p/micrometer-p8-pausedetector/">micrometer 系列 8： PauseDetector 以及 LatencyUtils</a> : https://ycwu314.cloud/p/micrometer-p8-pausedetector/</p><p style="text-align:center;font-size:16px;font-weight:700">你的支持将鼓励我继续更多原创分享！</p><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="https://s2.ax1x.com/2019/08/12/ezfUk8.jpg" style="width:50%;margin:0 auto"></div><div class="popular-posts-header">相关文章</div><ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><a href="/p/micrometer-p3-timer/" rel="bookmark">micrometer 系列 3：timer</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/p/micrometer-p6-distributionsummary-histogram/" rel="bookmark">micrometer 系列 6： DistributionSummary</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/p/micrometer-p5-gauge/" rel="bookmark">micrometer 系列 5： gauge</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/p/micrometer-p4-rate-aggregation/" rel="bookmark">micrometer 系列 4：rate aggregated</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/p/micrometer-p7-jvm-metrics/" rel="bookmark">micrometer 系列 7：jvm metrics</a></div></li></ul><div><div id="reward-container"><div>你的支持将鼓励我继续更多原创分享！</div><button id="reward-button" disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">打赏</button><div id="qr" style="display:none"><div style="display:inline-block"><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="https://s2.ax1x.com/2019/08/12/ezfUk8.jpg" alt="ycwu314 微信支付"><p>微信支付</p></div></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者： </strong>ycwu314</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://ycwu314.cloud/p/micrometer-p8-pausedetector/" title="micrometer 系列 8： PauseDetector 以及 LatencyUtils">https://ycwu314.cloud/p/micrometer-p8-pausedetector/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均为原创文章，未经允许请勿转载！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/t/监控/" rel="tag"># 监控</a> <a href="/t/micrometer/" rel="tag"># micrometer</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/p/cas-login/" rel="next" title="cas login 流程笔记"><i class="fa fa-chevron-left"></i> cas login 流程笔记</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/p/mysql-ONLY-FULL-GROUP-BY/" rel="prev" title="mysql ONLY_FULL_GROUP_BY 问题">mysql ONLY_FULL_GROUP_BY 问题 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/avatar.webp" alt="ycwu314"><p class="site-author-name" itemprop="name">ycwu314</p><div class="site-description motion-element" itemprop="description">java, 微服务, 分布式系统, 架构设计</div></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/arch"><span class="site-state-item-count">268</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/c/"><span class="site-state-item-count">57</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/t/"><span class="site-state-item-count">99</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/ycwu314" title="GitHub &rarr; https://github.com/ycwu314" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:ycwu314@foxmail.com" title="E-Mail &rarr; mailto:ycwu314@foxmail.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div></div></div><div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#背景"><span class="nav-number">1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#why-latency"><span class="nav-number">2.</span> <span class="nav-text">why latency ?</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#PauseDetector 体系"><span class="nav-number">3.</span> <span class="nav-text">PauseDetector 体系</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SimplePauseDetector"><span class="nav-number">4.</span> <span class="nav-text">SimplePauseDetector</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#IntervalEstimator"><span class="nav-number">5.</span> <span class="nav-text">IntervalEstimator</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考"><span class="nav-number">6.</span> <span class="nav-text">参考</span></a></li></ol></div></div></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2020</span> <span class="with-love" id="animate"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">ycwu314</span> <span class="post-meta-divider">|</span> <span class="post-count">共&nbsp;275.1k&nbsp;字</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/velocity/1.2.1/velocity.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/velocity/1.2.1/velocity.ui.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.6/jquery.fancybox.min.js"></script><script src="/js/utils.js?v=7.1.2"></script><script src="/js/motion.js?v=7.1.2"></script><script src="/js/schemes/muse.js?v=7.1.2"></script><script src="/js/scrollspy.js?v=7.1.2"></script><script src="/js/post-details.js?v=7.1.2"></script><script src="/js/next-boot.js?v=7.1.2"></script><script>function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var e=$("#local-search-input");e.attr("autocapitalize","none"),e.attr("autocorrect","off"),e.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(e){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(e,t,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:e,dataType:isXml?"xml":"json",async:!0,success:function(e){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",e).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():e,r=document.getElementById(t),s=document.getElementById(o),a=function(){var e=r.value.trim().toLowerCase(),t=e.split(/[\s\-]+/);t.length>1&&t.push(e);var o=[];if(e.length>0&&n.forEach(function(n){function r(t,o,n,r){for(var s=r[r.length-1],a=s.position,i=s.word,l=[],h=0;a+i.length<=n&&0!=r.length;){i===e&&h++,l.push({position:a,length:i.length});var p=a+i.length;for(r.pop();0!=r.length&&(s=r[r.length-1],a=s.position,i=s.word,p>a);)r.pop()}return c+=h,{hits:l,start:o,end:n,searchTextCount:h}}function s(e,t){var o="",n=t.start;return t.hits.forEach(function(t){o+=e.substring(n,t.position);var r=t.position+t.length;o+='<b class="search-keyword">'+e.substring(t.position,r)+"</b>",n=r}),o+=e.substring(n,t.end)}var a=!1,i=0,c=0,l=n.title.trim(),h=l.toLowerCase(),p=n.content.trim().replace(/<[^>]+>/g,""),u=p.toLowerCase(),f=decodeURIComponent(n.url).replace(/\/{2,}/g,"/"),d=[],g=[];if(""!=l&&(t.forEach(function(e){function t(e,t,o){var n=e.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(t=t.toLowerCase(),e=e.toLowerCase());(s=t.indexOf(e,r))>-1;)a.push({position:s,word:e}),r=s+n;return a}d=d.concat(t(e,h,!1)),g=g.concat(t(e,u,!1))}),(d.length>0||g.length>0)&&(a=!0,i=d.length+g.length)),a){[d,g].forEach(function(e){e.sort(function(e,t){return t.position!==e.position?t.position-e.position:e.word.length-t.word.length})});var v=[];0!=d.length&&v.push(r(l,0,l.length,d));for(var $=[];0!=g.length;){var C=g[g.length-1],m=C.position,x=C.word,w=m-20,y=m+80;0>w&&(w=0),y<m+x.length&&(y=m+x.length),y>p.length&&(y=p.length),$.push(r(p,w,y,g))}$.sort(function(e,t){return e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hits.length!==t.hits.length?t.hits.length-e.hits.length:e.start-t.start});var T=parseInt("1");T>=0&&($=$.slice(0,T));var b="";b+=0!=v.length?"<li><a href='"+f+"' class='search-result-title'>"+s(l,v[0])+"</a>":"<li><a href='"+f+"' class='search-result-title'>"+l+"</a>",$.forEach(function(e){b+="<a href='"+f+'\'><p class="search-result">'+s(p,e)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:c,hitCount:i,id:o.length})}}),1===t.length&&""===t[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x"></i></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>';else{o.sort(function(e,t){return e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hitCount!==t.hitCount?t.hitCount-e.hitCount:t.id-e.id});var a='<ul class="search-result-list">';o.forEach(function(e){a+=e.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(e){e.stopPropagation(),isfetched===!1?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(e){e.stopPropagation()}),$(document).on("keyup",function(e){var t=27===e.which&&$(".search-popup").is(":visible");t&&onPopupClose()})</script><script>!function(t){function n(){for(var n=0;n<e.length;n++)i=e[n],0<=(o=i.getBoundingClientRect()).top&&0<=o.left&&o.top<=(t.innerHeight||document.documentElement.clientHeight)&&function(){var t,i,o,c,r=e[n];t=r,i=function(){e=e.filter(function(t){return r!==t})},o=new Image,c=t.getAttribute("data-original"),o.onload=function(){t.src=c,i&&i()},o.src=c}();var i,o}var e=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));n(),t.addEventListener("scroll",function(){!function(t,n){clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)}(n,t)})}(this)</script></body></html><!-- rebuild by neat -->