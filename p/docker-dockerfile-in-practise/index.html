<!-- build time:Thu Dec 24 2020 16:28:34 GMT+0800 (China Standard Time) --><!DOCTYPE html><html class="theme-next mist use-motion" lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="keywords" content="java,微服务,分布式系统,架构设计"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.6/jquery.fancybox.min.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.2/css/font-awesome.min.css"><link rel="stylesheet" href="/css/main.css?v=7.1.2"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.2"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.2"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.2"><link rel="mask-icon" href="/images/logo.svg?v=7.1.2" color="#222"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",version:"7.1.2",sidebar:{position:"left",display:"hide",offset:12,onmobile:!1,dimmer:!1},back2top:!0,back2top_sidebar:!1,fancybox:!0,fastclick:!1,lazyload:!1,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta name="description" content="整理dockerfile编写经验"><meta name="keywords" content="docker env"><meta property="og:type" content="article"><meta property="og:title" content="dockerfile 使用经验"><meta property="og:url" content="https://ycwu314.cloud/p/docker-dockerfile-in-practise/index.html"><meta property="og:site_name" content="ycwu314"><meta property="og:description" content="整理dockerfile编写经验"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2020-12-24T08:26:51.327Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="dockerfile 使用经验"><meta name="twitter:description" content="整理dockerfile编写经验"><link rel="canonical" href="https://ycwu314.cloud/p/docker-dockerfile-in-practise/"><script id="page.configurations">CONFIG.page={sidebar:""}</script><title>dockerfile 使用经验 | ycwu314</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">ycwu314</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">潮的工地</h1></div><div class="site-nav-toggle"><button aria-label="切换导航栏"><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-collection"><a href="/collection" rel="section"><i class="menu-item-icon fa fa-fw fa-file-code-o"></i><br>专题</a></li><li class="menu-item menu-item-tags"><a href="/t/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://ycwu314.cloud/p/docker-dockerfile-in-practise/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="ycwu314"><meta itemprop="description" content="java, 微服务, 分布式系统, 架构设计"><meta itemprop="image" content="/images/avatar.webp"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="ycwu314"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">dockerfile 使用经验</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-05-09 10:31:00" itemprop="dateCreated datePublished" datetime="2020-05-09T10:31:00+08:00">2020-05-09</time> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2020-12-24 16:26:51" itemprop="dateModified" datetime="2020-12-24T16:26:51+08:00">2020-12-24</time> </span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/c/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a></span></span><br><span title="post.wordcount">共&nbsp;2.1k&nbsp;字 <span class="post-meta-divider">|</span> </span><span title="post.min2read">阅读时间&nbsp;9&nbsp;分钟</span><div class="post-description">整理dockerfile编写经验</div></div></header><div class="post-body" itemprop="articleBody"><p style="text-align:center;font-size:14px">本文作者ycwu314，未经允许请勿转载 <a href="https://ycwu314.cloud/p/docker-dockerfile-in-practise/">dockerfile 使用经验</a> : https://ycwu314.cloud/p/docker-dockerfile-in-practise/<br>&#x6E29;&#x99A8;&#x63D0;&#x793A;&#xFF1A;&#x5982;&#x679C;&#x4E0D;&#x662F;&#x5728;&#x8FD9;&#x4E9B;&#x5730;&#x65B9;&#x770B;&#x5230;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#xFF0C;&#x90A3;&#x4E48;&#x4F60;&#x53EF;&#x80FD;&#x662F;&#x722C;&#x866B;&#x6587;&#x7AE0;&#x7684;&#x53D7;&#x5BB3;&#x8005;&#xFF1A;<br>https://ycwu314.top/ (原https://ycwu314.github.io/)<br>&#x672A;&#x7ECF;&#x6388;&#x6743;&#x7684;&#x8F6C;&#x8F7D;&#xFF0C;&#x4E0D;&#x4EC5;&#x6253;&#x51FB;&#x539F;&#x521B;&#x79EF;&#x6781;&#x6027;&#xFF0C;&#x8FD8;&#x83B7;&#x53D6;&#x4E0D;&#x5230;&#x6700;&#x65B0;&#x7684;&#x6587;&#x7AE0;&#x66F4;&#x65B0;&#x4FE1;&#x606F;&#x3002;</p><h1 id="docker-build- 命令"><a href="#docker-build- 命令" class="headerlink" title="docker build 命令"></a>docker build 命令</h1><p>在 Dockerfile 所在目录</p><a id="more"></a><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="BASH"><figure class="iseeu highlight /bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -t            Name and optionally a tag in the 'name:tag' format</span></span><br><span class="line"><span class="comment"># -f            Name of the Dockerfile (Default is 'PATH/Dockerfile')</span></span><br><span class="line"><span class="comment"># --force-rm    Always remove intermediate containers</span></span><br><span class="line"><span class="comment"># --no-cache    Do not use cache when building the image (很慢)</span></span><br><span class="line"></span><br><span class="line">docker build -t ycwu/ycwu-alpine:v1 .</span><br></pre></td></tr></table></figure></div><p>最后的 <code>.</code> 表示使用当前目录作为工作目录，ADD、COPY 等命令以此作为操作的上下文。<br>如果文件名不是 Dockerfile，要 <code>-f</code> 指定。</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="BASH"><figure class="iseeu highlight /bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker build --no-cache=<span class="literal">true</span> -f /path/to/Dockerfile -t some_tag -t image_name:image_version /path/to/build</span><br></pre></td></tr></table></figure></div><h1 id="ENV"><a href="#ENV" class="headerlink" title="ENV"></a>ENV</h1><p>通过 ENV 定义的环境变量，可以在 dockerfile 被后面的所有指令中使用。</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="DOCKERFILE"><figure class="iseeu highlight /dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"><span class="comment"># 使用等号，可以在一个 ENV 指定设置多个环境变量 </span></span><br><span class="line"><span class="keyword">ENV</span> a=<span class="number">1</span> b=<span class="number">2</span>            </span><br><span class="line"><span class="keyword">ENV</span> c <span class="number">3</span></span><br></pre></td></tr></table></figure></div><p>ENV 的内容会写入层。但是经过测试，非等号语法方式设置环境变量，偶尔不能正确持久化到层，有些奇怪。</p><p>在<code>docker run</code>命令中通过 <code>-e</code> 标记来传递环境变量，这样容器运行时就可以使用该变量。</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --env &lt;key&gt;=&lt;value&gt;</span><br></pre></td></tr></table></figure></div><p>如果只需要对一条指令设置环境变量，可以使用这种方式：<code>RUN &lt;key&gt;=&lt;value&gt; &lt;command&gt;</code>。</p><h1 id="WORKDIR"><a href="#WORKDIR" class="headerlink" title="WORKDIR"></a>WORKDIR</h1><p>指定工作目录。如果不存在，则自动创建。</p><h1 id="复制文件"><a href="# 复制文件" class="headerlink" title="复制文件"></a>复制文件</h1><p>对于 COPY 和 ADD 命令来说，如果要把本地的文件拷贝到镜像中，那么本地的文件必须是在上下文目录中的文件。因为在执行 build 命令时，docker 客户端会把上下文中的所有文件发送给 docker daemon。</p><p><strong>COPY 和 ADD 都只复制目录中的内容而不包含目录自身 </strong>。</p><p>举个例子，Dockerfile 所在上下文目录情况：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@host143 tmp]# ls -al</span><br><span class="line">总用量 4</span><br><span class="line">drwxr-xr-x  3 root root  36 5 月   9 11:30 .</span><br><span class="line">drwxr-xr-x. 7 root root 138 5 月   9 11:27 ..</span><br><span class="line">-rw-r--r--  1 root root  80 5 月   9 11:33 Dockerfile</span><br><span class="line">drwxr-xr-x  2 root root  32 5 月   9 11:28 haha</span><br><span class="line">[root@host143 tmp]# ls -al haha</span><br><span class="line">总用量 8</span><br><span class="line">drwxr-xr-x 2 root root 32 5 月   9 11:28 .</span><br><span class="line">drwxr-xr-x 3 root root 36 5 月   9 11:30 ..</span><br><span class="line">-rw-r--r-- 1 root root  5 5 月   9 11:28 1.txt</span><br><span class="line">-rw-r--r-- 1 root root  8 5 月   9 11:28 2.txt</span><br></pre></td></tr></table></figure></div><p>执行如下的构建</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="DOCKERFILE"><figure class="iseeu highlight /dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine:<span class="number">3.11</span>.<span class="number">6</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> ycwu</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /data</span></span><br><span class="line"><span class="comment"># 把 haha 目录下内容复制到 /data 下面，不包括 haha 目录本身</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> haha .</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"sh"</span>]</span></span><br></pre></td></tr></table></figure></div><p>进去容器看看，没有 haha 目录。</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/data # ls -al</span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x    1 root     root            32 May  9 03:33 .</span><br><span class="line">drwxr-xr-x    1 root     root            18 May  9 03:33 ..</span><br><span class="line">-rw-r--r--    1 root     root             5 May  9 03:28 1.txt</span><br><span class="line">-rw-r--r--    1 root     root             8 May  9 03:28 2.txt</span><br></pre></td></tr></table></figure></div><p>如果要保留目录名，只需要在 <code>&lt;dest&gt;</code> 加上目录名：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="DOCKERFILE"><figure class="iseeu highlight /dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ADD</span><span class="bash"> haha ./haha</span></span><br></pre></td></tr></table></figure></div><p>进入容器看看：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/data # ls</span><br><span class="line">haha</span><br><span class="line">/data # ls haha</span><br><span class="line">1.txt  2.txt</span><br></pre></td></tr></table></figure></div><h2 id="ADD"><a href="#ADD" class="headerlink" title="ADD"></a>ADD</h2><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="DOCKERFILE"><figure class="iseeu highlight /dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ADD</span><span class="bash"> &lt;src&gt;... &lt;dest&gt;</span></span><br></pre></td></tr></table></figure></div><p>必须是在上下文目录和子目录中，无法添加 <code>../a.txt</code> 这样的文件。如果 <code>&lt;src&gt;</code> 是个目录，则复制的是目录下的所有内容，但不包括该目录。<br><code>&lt;dest&gt;</code>可以是绝对路径，也可以是相对 WORKDIR 目录的相对路径。</p><p>ADD 命令支持下载远程文件，但是官方例子建议使用 <code>RUN curl</code> 或者 <code>RUN wget</code> 替代，因为可以直接删除源文件。</p><blockquote><p>Because image size matters, using ADD to fetch packages from remote URLs is strongly discouraged; you should use curl or wget instead. That way you can delete the files you no longer need after they’ve been extracted and you don’t have to add another layer in your image. For example, you should avoid doing things like:</p></blockquote><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="DOCKERFILE"><figure class="iseeu highlight /dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ADD</span><span class="bash"> http://example.com/big.tar.xz /usr/src/things/</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> tar -xJf /usr/src/things/big.tar.xz -C /usr/src/things</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> make -C /usr/src/things all</span></span><br></pre></td></tr></table></figure></div><p>And instead, do something like:</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="DOCKERFILE"><figure class="iseeu highlight /dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir -p /usr/src/things \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -SL http://example.com/big.tar.xz \</span></span><br><span class="line"><span class="bash">    | tar -xJC /usr/src/things \</span></span><br><span class="line"><span class="bash">    &amp;&amp; make -C /usr/src/things all</span></span><br></pre></td></tr></table></figure></div><p>ADD 支持自动解压缩文件，比如 tar。</p><h2 id="COPY"><a href="#COPY" class="headerlink" title="COPY"></a>COPY</h2><p>COPY 最重要的功能是 multi-stage build 中复制产物。</p><h2 id="技巧"><a href="# 技巧" class="headerlink" title="技巧"></a>技巧</h2><p>如果要把多个文件复制到容器，其中有不经常变更、经常变更的文件，那么应该分开写，加速镜像构建。</p><p>假设 a.txt（不经常变更）、b.txt（经常变更）、c.txt（经常变更）。</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="DOCKERFILE"><figure class="iseeu highlight /dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># a.txt 不经常变更，单独占一层，大概率可以重用缓存。</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> a.txt .</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> b.txt c.txt .</span></span><br></pre></td></tr></table></figure></div><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="DOCKERFILE"><figure class="iseeu highlight /dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># change apk source mirrors</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> http://mirrors.ustc.edu.cn/alpine/v3.11/main &gt; /etc/apk/repositories &amp;&amp; \</span></span><br><span class="line"><span class="bash">    <span class="built_in">echo</span> http://mirrors.ustc.edu.cn/alpine/v3.11/community &gt;&gt; /etc/apk/repositories</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apk update &amp;&amp; apk upgrade</span></span><br></pre></td></tr></table></figure></div><h1 id="shell 模式和 exec 模式"><a href="#shell 模式和 exec 模式" class="headerlink" title="shell 模式和 exec 模式"></a>shell 模式和 exec 模式</h1><ul><li>Shell 格式：<code>&lt;instruction&gt; &lt;command&gt;</code>。</li><li>Exec 格式：<code>&lt;instruction&gt; [&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot;, ...]</code>。</li></ul><p>exec 模式的参数要使用双括号：</p><blockquote><p>The exec form is parsed as a JSON array, which means that you must use double-quotes (“) around words not single-quotes (‘).</p></blockquote><h2 id="shell 模式"><a href="#shell 模式" class="headerlink" title="shell 模式"></a>shell 模式</h2><p>使用 shell 模式时，docker 会以 <code>/bin/sh -c &quot;task command&quot;</code> 的方式执行任务命令。也就是说容器中的 1 号进程不是任务进程而是 bash 进程。<br>shell 模式可以解析变量。</p><h2 id="exec 模式"><a href="#exec 模式" class="headerlink" title="exec 模式"></a>exec 模式</h2><p>使用 exec 模式时，容器中的任务进程就是容器内的 1 号进程。<br>（如果执行 shell 脚本，则依然是 sh）</p><p>因为 exec 模式不启动 shell，因此默认情况下缺少环境变量解析的能力。如果要解析环境变量，可以：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="DOCKERFILE"><figure class="iseeu highlight /dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"/bin/bash"</span>, <span class="string">"-c"</span>, <span class="string">"echo"</span>, <span class="string">"<span class="variable">$HOME</span>"</span>]</span></span><br></pre></td></tr></table></figure></div><h1 id="ETNTRYPOINT-amp-CMD"><a href="#ETNTRYPOINT-amp-CMD" class="headerlink" title="ETNTRYPOINT &amp; CMD"></a>ETNTRYPOINT &amp; CMD</h1><h2 id="ENTRYPOINT"><a href="#ENTRYPOINT" class="headerlink" title="ENTRYPOINT"></a>ENTRYPOINT</h2><p>指定镜像的执行程序，只有最后一条 ENTRYPOINT 指令有效。</p><p>如果想要覆盖 ENTRYPOINT 命令，需要在 docker run -it [image]后面添加–entrypoint string 参数</p><p>每个 Dockerfile 只能有一个 ENTRYPOINT 命令，如果存在多个 ENTRYPOINT 命令，则执行最后一个 ENTRYPOINT。</p><h2 id="CMD"><a href="#CMD" class="headerlink" title="CMD"></a>CMD</h2><p><strong>CMD 指令允许用户指定容器的默认执行的命令。此命令会在容器启动且 docker run 没有指定其他命令时运行。</strong></p><p>每个 Dockerfile 只能有一个 CMD 命令，如果存在多个 CMD 命令，则执行最后一个 CMD。</p><h2 id="区别"><a href="# 区别" class="headerlink" title="区别"></a>区别</h2><p>ENTRYPOINT 中的参数始终会被使用。<br>CMD 设置的命令能够被 docker run 命令后面的命令行参数替换。</p><h1 id="docker-entryfile-sh"><a href="#docker-entryfile-sh" class="headerlink" title="docker entryfile sh"></a>docker entryfile sh</h1><p>一些软件提供提供的 dockerfile，入口的 <code>docker-entrypoint.sh</code> 脚本值得看看。<br>以 <a href="https://raw.githubusercontent.com/docker-library/mysql/607b2a65aa76adf495730b9f7e6f28f146a9f95f/5.7/docker-entrypoint.sh" rel="external nofollow noopener noreferrer" target="_blank">mysql 5.7 docker-entrypoint.sh</a> 为例子。</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="SH"><figure class="iseeu highlight /sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> -eo pipefail</span><br><span class="line"><span class="built_in">shopt</span> -s nullglob</span><br><span class="line"></span><br><span class="line"><span class="comment"># if command starts with an option, prepend mysqld</span></span><br><span class="line"><span class="keyword">if</span> [<span class="string">"<span class="variable">$&#123;1:0:1&#125;</span>"</span> = <span class="string">'-'</span> ]; <span class="keyword">then</span></span><br><span class="line">	<span class="built_in">set</span> -- mysqld <span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></div><h2 id="set"><a href="#set" class="headerlink" title="set"></a>set</h2><ul><li><p><code>set -e</code>: 后续脚本执行遇到非 0 返回值就退出。好处遇到执行错误就退出，避免往后产生更多错误。</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Exit immediately if a pipeline (which may consist of a single simple command), a subshell </span><br><span class="line">command enclosed in parentheses, or one of the commands executed as part of a command list</span><br><span class="line">enclosed by braces (see SHELL GRAMMAR above) exits with a non-zero status.</span><br></pre></td></tr></table></figure></div></li><li><p><code>set -o pipefail</code>：管道模式的命令，遇到错误就退出执行。</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">If set, the return value of a pipeline is the value of the last (rightmost) command to exit with a non-zero status,or zero if all commands in the pipeline exit successfully. This option is disabled by default.</span><br></pre></td></tr></table></figure></div></li></ul><h2 id="shopt"><a href="#shopt" class="headerlink" title="shopt"></a>shopt</h2><p>shopt 命令用于显示和设置 shell 中的行为选项。<br><code>shopt -s nullglob</code>：如果 nullglob 选项被设置，并且没有找到任何匹配，这个单词被删除。</p><h2 id="if-quot-1-0-1-quot-39-39"><a href="#if-quot-1-0-1-quot-39-39" class="headerlink" title="if [ &quot;${1:0:1}&quot; = &#39;-&#39; ];"></a><code>if [&quot;${1:0:1}&quot; = &#39;-&#39; ];</code></h2><p><code>${1:0:1}</code>是 bash 的语法。从第 N 个参数截取字符串。<br>第一个参数：命令行传入的第 N 个参数。<br>第二个参数：截取的开始索引。<br>第三个参数：截取的结束索引。</p><p><code>${1:0:1}</code>是指从 <code>$1</code> 截取 <code>0-1</code> 的字符串。<br>整个 if 判断看是不是 <code>-</code> 开头的选项。</p><h2 id="set-mysqld-quot-quot"><a href="#set-mysqld-quot-quot" class="headerlink" title="set -- mysqld &quot;$@&quot;"></a><code>set -- mysqld &quot;$@&quot;</code></h2><p><code>set --</code>会将他后面所有以空格区分的字符串, 按顺序分别存储 <code>$1</code>，<code>$2</code>，… ，<code>$@</code>。</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">If no arguments follow this option, then the positional parameters are unset. Otherwise, the</span><br><span class="line">positional parameters are set to the args, even if some of them begin with a -.</span><br></pre></td></tr></table></figure></div><p>当 <code>$*</code> 和 <code>$@</code> 不被双引号 <code>&quot; &quot;</code> 包围时，它们之间没有任何区别，都是将接收到的每个参数看做一份数据，彼此之间以空格来分隔。<br>但是当它们被双引号 <code>&quot; &quot;</code> 包含时，就会有区别了：</p><ul><li><code>&quot;$*&quot;</code>会将所有的参数从整体上看做一份数据，而不是把每个参数都看做一份数据。</li><li><code>$@&quot;</code>仍然将每个参数都看作一份数据，彼此之间是独立的。</li></ul><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="BASH"><figure class="iseeu highlight /bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#! /bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"param:"</span> $*</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'loop"$@"'</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$x</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'loop "$*"'</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">"$*"</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$x</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></div><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="BASH"><figure class="iseeu highlight /bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@host143 ycwu]<span class="comment"># ./t2.sh 123 456</span></span><br><span class="line">param:  123 456</span><br><span class="line">loop <span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line">123</span><br><span class="line">456</span><br><span class="line"></span><br><span class="line">loop <span class="string">"$*"</span></span><br><span class="line">123 456</span><br></pre></td></tr></table></figure></div><h2 id="exec"><a href="#exec" class="headerlink" title="exec"></a>exec</h2><p>使用 exec command 方式，会用 command 进程替换当前 shell 进程，并且保持 PID 不变。执行完毕，直接退出，不回到之前的 shell 环境。</p><p><code>exec &quot;$@&quot;</code>: 作为 entrypoint 的兜底，执行用户传入的命令。</p><h1 id="参考"><a href="# 参考" class="headerlink" title="参考"></a>参考</h1><ul><li><a href="https://github.com/qianlei90/Blog/issues/35" rel="external nofollow noopener noreferrer" target="_blank">深入 Dockerfile（一）: 语法指南</a></li><li><a href="https://www.cnblogs.com/sparkdev/p/9573248.html" rel="external nofollow noopener noreferrer" target="_blank">Dockerfile 中的 COPY 与 ADD 命令</a></li><li><a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices" rel="external nofollow noopener noreferrer" target="_blank">Best practices for writing Dockerfiles</a></li><li><a href="https://www.cnblogs.com/breezey/p/8812197.html" rel="external nofollow noopener noreferrer" target="_blank">docker entrypoint 入口文件详解</a></li><li><a href="https://www.cnblogs.com/ivictor/p/4832832.html" rel="external nofollow noopener noreferrer" target="_blank">分析 Mysql 5.6 的 Dockerfile</a></li><li><a href="https://www.jianshu.com/p/ca012415cd5f" rel="external nofollow noopener noreferrer" target="_blank">【exec】shell 脚本中的 exec 命令</a></li></ul><h1>题外话</h1><p style="text-align:center;font-size:14px">&#x672C;&#x6587;&#x4F5C;&#x8005;ycwu314，&#x672A;&#x7ECF;&#x5141;&#x8BB8;&#x8BF7;&#x52FF;&#x8F6C;&#x8F7D; <a href="https://ycwu314.cloud/p/docker-dockerfile-in-practise/">dockerfile 使用经验</a> : https://ycwu314.cloud/p/docker-dockerfile-in-practise/</p><p style="text-align:center;font-size:16px;font-weight:700">你的支持将鼓励我继续更多原创分享！</p><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="https://s2.ax1x.com/2019/08/12/ezfUk8.jpg" style="width:50%;margin:0 auto"></div><div class="popular-posts-header">相关文章</div><ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><a href="/p/linux-hostname-dns-config-files/" rel="bookmark">linux 主机解析相关配置文件</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/p/docker-macvlan-network/" rel="bookmark">docker macvlan network 实验</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/p/docker-overlay-network/" rel="bookmark">docker overlay network 实验</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/p/iptables-docker/" rel="bookmark">iptables docker</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/p/docker-nsenter/" rel="bookmark">使用 nsenter 访问 docker 容器</a></div></li></ul><div><div id="reward-container"><div>你的支持将鼓励我继续更多原创分享！</div><button id="reward-button" disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">打赏</button><div id="qr" style="display:none"><div style="display:inline-block"><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="https://s2.ax1x.com/2019/08/12/ezfUk8.jpg" alt="ycwu314 微信支付"><p>微信支付</p></div></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者： </strong>ycwu314</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://ycwu314.cloud/p/docker-dockerfile-in-practise/" title="dockerfile 使用经验">https://ycwu314.cloud/p/docker-dockerfile-in-practise/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均为原创文章，未经允许请勿转载！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/t/docker/" rel="tag"># docker</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/p/linux-localtime-and-timezone/" rel="next" title="linux localtime 和 timezone"><i class="fa fa-chevron-left"></i> linux localtime 和 timezone</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/p/docker-init-and-zombie-reaping/" rel="prev" title="docker & 僵尸进程 & tini">docker & 僵尸进程 & tini <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/avatar.webp" alt="ycwu314"><p class="site-author-name" itemprop="name">ycwu314</p><div class="site-description motion-element" itemprop="description">java, 微服务, 分布式系统, 架构设计</div></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/arch"><span class="site-state-item-count">268</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/c/"><span class="site-state-item-count">57</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/t/"><span class="site-state-item-count">99</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/ycwu314" title="GitHub &rarr; https://github.com/ycwu314" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:ycwu314@foxmail.com" title="E-Mail &rarr; mailto:ycwu314@foxmail.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div></div></div><div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#docker-build- 命令"><span class="nav-number">1.</span> <span class="nav-text">docker build 命令</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ENV"><span class="nav-number">2.</span> <span class="nav-text">ENV</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WORKDIR"><span class="nav-number">3.</span> <span class="nav-text">WORKDIR</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#复制文件"><span class="nav-number">4.</span> <span class="nav-text">复制文件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ADD"><span class="nav-number">4.1.</span> <span class="nav-text">ADD</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#COPY"><span class="nav-number">4.2.</span> <span class="nav-text">COPY</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#技巧"><span class="nav-number">4.3.</span> <span class="nav-text">技巧</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#shell 模式和 exec 模式"><span class="nav-number">5.</span> <span class="nav-text">shell 模式和 exec 模式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#shell 模式"><span class="nav-number">5.1.</span> <span class="nav-text">shell 模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exec 模式"><span class="nav-number">5.2.</span> <span class="nav-text">exec 模式</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ETNTRYPOINT-amp-CMD"><span class="nav-number">6.</span> <span class="nav-text">ETNTRYPOINT &amp; CMD</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ENTRYPOINT"><span class="nav-number">6.1.</span> <span class="nav-text">ENTRYPOINT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CMD"><span class="nav-number">6.2.</span> <span class="nav-text">CMD</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#区别"><span class="nav-number">6.3.</span> <span class="nav-text">区别</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#docker-entryfile-sh"><span class="nav-number">7.</span> <span class="nav-text">docker entryfile sh</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#set"><span class="nav-number">7.1.</span> <span class="nav-text">set</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#shopt"><span class="nav-number">7.2.</span> <span class="nav-text">shopt</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#if-quot-1-0-1-quot-39-39"><span class="nav-number">7.3.</span> <span class="nav-text">if [&quot;${1:0:1}&quot; = &#39;-&#39; ];</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#set-mysqld-quot-quot"><span class="nav-number">7.4.</span> <span class="nav-text">set -- mysqld &quot;$@&quot;</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exec"><span class="nav-number">7.5.</span> <span class="nav-text">exec</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考"><span class="nav-number">8.</span> <span class="nav-text">参考</span></a></li></ol></div></div></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2020</span> <span class="with-love" id="animate"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">ycwu314</span> <span class="post-meta-divider">|</span> <span class="post-count">共&nbsp;275.1k&nbsp;字</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/velocity/1.2.1/velocity.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/velocity/1.2.1/velocity.ui.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.6/jquery.fancybox.min.js"></script><script src="/js/utils.js?v=7.1.2"></script><script src="/js/motion.js?v=7.1.2"></script><script src="/js/schemes/muse.js?v=7.1.2"></script><script src="/js/scrollspy.js?v=7.1.2"></script><script src="/js/post-details.js?v=7.1.2"></script><script src="/js/next-boot.js?v=7.1.2"></script><script>function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var e=$("#local-search-input");e.attr("autocapitalize","none"),e.attr("autocorrect","off"),e.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(e){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(e,t,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:e,dataType:isXml?"xml":"json",async:!0,success:function(e){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",e).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():e,r=document.getElementById(t),s=document.getElementById(o),a=function(){var e=r.value.trim().toLowerCase(),t=e.split(/[\s\-]+/);t.length>1&&t.push(e);var o=[];if(e.length>0&&n.forEach(function(n){function r(t,o,n,r){for(var s=r[r.length-1],a=s.position,i=s.word,l=[],h=0;a+i.length<=n&&0!=r.length;){i===e&&h++,l.push({position:a,length:i.length});var p=a+i.length;for(r.pop();0!=r.length&&(s=r[r.length-1],a=s.position,i=s.word,p>a);)r.pop()}return c+=h,{hits:l,start:o,end:n,searchTextCount:h}}function s(e,t){var o="",n=t.start;return t.hits.forEach(function(t){o+=e.substring(n,t.position);var r=t.position+t.length;o+='<b class="search-keyword">'+e.substring(t.position,r)+"</b>",n=r}),o+=e.substring(n,t.end)}var a=!1,i=0,c=0,l=n.title.trim(),h=l.toLowerCase(),p=n.content.trim().replace(/<[^>]+>/g,""),u=p.toLowerCase(),f=decodeURIComponent(n.url).replace(/\/{2,}/g,"/"),d=[],g=[];if(""!=l&&(t.forEach(function(e){function t(e,t,o){var n=e.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(t=t.toLowerCase(),e=e.toLowerCase());(s=t.indexOf(e,r))>-1;)a.push({position:s,word:e}),r=s+n;return a}d=d.concat(t(e,h,!1)),g=g.concat(t(e,u,!1))}),(d.length>0||g.length>0)&&(a=!0,i=d.length+g.length)),a){[d,g].forEach(function(e){e.sort(function(e,t){return t.position!==e.position?t.position-e.position:e.word.length-t.word.length})});var v=[];0!=d.length&&v.push(r(l,0,l.length,d));for(var $=[];0!=g.length;){var C=g[g.length-1],m=C.position,x=C.word,w=m-20,y=m+80;0>w&&(w=0),y<m+x.length&&(y=m+x.length),y>p.length&&(y=p.length),$.push(r(p,w,y,g))}$.sort(function(e,t){return e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hits.length!==t.hits.length?t.hits.length-e.hits.length:e.start-t.start});var T=parseInt("1");T>=0&&($=$.slice(0,T));var b="";b+=0!=v.length?"<li><a href='"+f+"' class='search-result-title'>"+s(l,v[0])+"</a>":"<li><a href='"+f+"' class='search-result-title'>"+l+"</a>",$.forEach(function(e){b+="<a href='"+f+'\'><p class="search-result">'+s(p,e)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:c,hitCount:i,id:o.length})}}),1===t.length&&""===t[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x"></i></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>';else{o.sort(function(e,t){return e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hitCount!==t.hitCount?t.hitCount-e.hitCount:t.id-e.id});var a='<ul class="search-result-list">';o.forEach(function(e){a+=e.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(e){e.stopPropagation(),isfetched===!1?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(e){e.stopPropagation()}),$(document).on("keyup",function(e){var t=27===e.which&&$(".search-popup").is(":visible");t&&onPopupClose()})</script><script>!function(t){function n(){for(var n=0;n<e.length;n++)i=e[n],0<=(o=i.getBoundingClientRect()).top&&0<=o.left&&o.top<=(t.innerHeight||document.documentElement.clientHeight)&&function(){var t,i,o,c,r=e[n];t=r,i=function(){e=e.filter(function(t){return r!==t})},o=new Image,c=t.getAttribute("data-original"),o.onload=function(){t.src=c,i&&i()},o.src=c}();var i,o}var e=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));n(),t.addEventListener("scroll",function(){!function(t,n){clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)}(n,t)})}(this)</script></body></html><!-- rebuild by neat -->