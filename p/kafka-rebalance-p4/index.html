<!-- build time:Thu Dec 24 2020 16:28:35 GMT+0800 (China Standard Time) --><!DOCTYPE html><html class="theme-next mist use-motion" lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="keywords" content="java,微服务,分布式系统,架构设计"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.6/jquery.fancybox.min.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.2/css/font-awesome.min.css"><link rel="stylesheet" href="/css/main.css?v=7.1.2"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.2"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.2"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.2"><link rel="mask-icon" href="/images/logo.svg?v=7.1.2" color="#222"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",version:"7.1.2",sidebar:{position:"left",display:"hide",offset:12,onmobile:!1,dimmer:!1},back2top:!0,back2top_sidebar:!1,fancybox:!0,fastclick:!1,lazyload:!1,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta name="description" content="kafka 2.3 增加了incremental cooperative rebalancing，对大规模消费者集群的重平衡进行优化。"><meta name="keywords" content="kafka incremental cooperative rebalancing"><meta property="og:type" content="article"><meta property="og:title" content="kafka rebalance 系列：incremental cooperative rebalancing"><meta property="og:url" content="https://ycwu314.cloud/p/kafka-rebalance-p4/index.html"><meta property="og:site_name" content="ycwu314"><meta property="og:description" content="kafka 2.3 增加了incremental cooperative rebalancing，对大规模消费者集群的重平衡进行优化。"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2020-12-24T08:26:51.343Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="kafka rebalance 系列：incremental cooperative rebalancing"><meta name="twitter:description" content="kafka 2.3 增加了incremental cooperative rebalancing，对大规模消费者集群的重平衡进行优化。"><link rel="canonical" href="https://ycwu314.cloud/p/kafka-rebalance-p4/"><script id="page.configurations">CONFIG.page={sidebar:""}</script><title>kafka rebalance 系列：incremental cooperative rebalancing | ycwu314</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">ycwu314</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">潮的工地</h1></div><div class="site-nav-toggle"><button aria-label="切换导航栏"><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-collection"><a href="/collection" rel="section"><i class="menu-item-icon fa fa-fw fa-file-code-o"></i><br>专题</a></li><li class="menu-item menu-item-tags"><a href="/t/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://ycwu314.cloud/p/kafka-rebalance-p4/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="ycwu314"><meta itemprop="description" content="java, 微服务, 分布式系统, 架构设计"><meta itemprop="image" content="/images/avatar.webp"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="ycwu314"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">kafka rebalance 系列：incremental cooperative rebalancing</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-04-21 19:56:41" itemprop="dateCreated datePublished" datetime="2020-04-21T19:56:41+08:00">2020-04-21</time> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2020-12-24 16:26:51" itemprop="dateModified" datetime="2020-12-24T16:26:51+08:00">2020-12-24</time> </span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/c/kafka/" itemprop="url" rel="index"><span itemprop="name">kafka</span></a></span></span><br><span title="post.wordcount">共&nbsp;1.2k&nbsp;字 <span class="post-meta-divider">|</span> </span><span title="post.min2read">阅读时间&nbsp;5&nbsp;分钟</span><div class="post-description">kafka 2.3 增加了incremental cooperative rebalancing，对大规模消费者集群的重平衡进行优化。</div></div></header><div class="post-body" itemprop="articleBody"><p style="text-align:center;font-size:14px">本文作者ycwu314，未经允许请勿转载 <a href="https://ycwu314.cloud/p/kafka-rebalance-p4/">kafka rebalance 系列：incremental cooperative rebalancing</a> : https://ycwu314.cloud/p/kafka-rebalance-p4/<br>&#x6E29;&#x99A8;&#x63D0;&#x793A;&#xFF1A;&#x5982;&#x679C;&#x4E0D;&#x662F;&#x5728;&#x8FD9;&#x4E9B;&#x5730;&#x65B9;&#x770B;&#x5230;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#xFF0C;&#x90A3;&#x4E48;&#x4F60;&#x53EF;&#x80FD;&#x662F;&#x722C;&#x866B;&#x6587;&#x7AE0;&#x7684;&#x53D7;&#x5BB3;&#x8005;&#xFF1A;<br>https://ycwu314.top/ (原https://ycwu314.github.io/)<br>&#x672A;&#x7ECF;&#x6388;&#x6743;&#x7684;&#x8F6C;&#x8F7D;&#xFF0C;&#x4E0D;&#x4EC5;&#x6253;&#x51FB;&#x539F;&#x521B;&#x79EF;&#x6781;&#x6027;&#xFF0C;&#x8FD8;&#x83B7;&#x53D6;&#x4E0D;&#x5230;&#x6700;&#x65B0;&#x7684;&#x6587;&#x7AE0;&#x66F4;&#x65B0;&#x4FE1;&#x606F;&#x3002;</p><h1 id="Incremental-Cooperative-Rebalancing"><a href="#Incremental-Cooperative-Rebalancing" class="headerlink" title="Incremental Cooperative Rebalancing"></a>Incremental Cooperative Rebalancing</h1><blockquote><p>The key idea behind all the designs proposed here is to change the assumption we’ve always made with groups and their resources until now:<br>when you go into a JoinGroup, it is expected that you give up control of all resources that you control and get them into a clean state for handoff.</p></blockquote><p>在 kafka 2.3 以前，rebalance 对 kafka consumer 集群性能的影响，体现在一旦进入 JoinGroup 则立即放弃控制资源，其中涉及状态初始化、offset 提交、释放 partition，是耗时的操作。</p><a id="more"></a><p>KIP-429 这个 KIP 在原有的紧迫再平衡协议（eager rebalance protocol）的基础上，增加了消费者增量平衡协议（Incremental Rebalance Protocol）。<br>与 eager 协议不同，eager 协议总是在重新平衡之前撤销所有已分配的分区，然后尝试重新分配它们。<br>而 incremental 协议允许消费者在重新平衡事件期间保留其分区，从而尽量减少消费者组成员之间的分区迁移。因此，通过 scaling out/down 操作触发的端到端重新平衡时间更短，这有利于重量级、有状态的消费者，比如 Kafka Streams 应用程序。</p><blockquote><p>Incremental because the final desired state of rebalancing is reached in stages. A globally balanced final state does not have to be reached at the end of each round of rebalancing. A small number of consecutive rebalancing rounds can be used in order for the group of Kafka clients to converge to the desired state of balanced resources. In addition, you can configure a grace period to allow a departing member to return and regain its previously assigned resources.</p></blockquote><p>“增量”是指最终平衡状态经历多个阶段实现，而不需要在一次全局 stop-the-world 平衡中实现。可以设置一个 grace period，方便 consumer 重新加入和再次拿到之前分配的资源。</p><blockquote><p>Cooperative because each process in the group is asked to voluntarily release resources that need to be redistributed. These resources are then made available for rescheduling given that the client that was asked to release them does so on time.</p></blockquote><p>“协同”是指 group 内的进程自愿释放需要被重新分发的资源。</p><p>Incremental Cooperative Rebalancing 从以下 3 个方面进行优化：</p><ul><li>Design I: Simple Cooperative Rebalancing</li><li>Design II: Deferred Resolution of Imbalance</li><li>Design III: Incremental Resolution of Imbalance</li></ul><h1 id="Design-I-Simple-Cooperative-Rebalancing"><a href="#Design-I-Simple-Cooperative-Rebalancing" class="headerlink" title="Design I: Simple Cooperative Rebalancing"></a>Design I: Simple Cooperative Rebalancing</h1><p>member 进程:</p><ul><li>member 在 JoinGroup 中附带订阅的 topics，以及分配的 partitions 列表。</li><li><strong>在 JoinGroup 过程中，memeber 继续持有已有资源。（对比原来的设计：一旦进入 JoinGroup 则立即放弃控制资源）</strong></li><li>处理 assignment 中新分配的分区</li><li><strong>如果 assignment 包含 RevokePartitions，则立即停止处理对应的分区 </strong>，commit，并且立即初始化另一轮 join group</li></ul><p>leader 进程：</p><ul><li>为所有 member 计算分区；另外，通过 member 上报的信息，计算 RevokePartitions。</li><li>leader 要为 group 内失联的 topic partition 负责（持有这些分区的 member 可能不再返回）。解决方式是在上边步骤，分配分区的时候要包含所有分区（而不是只局限于上报的分区）</li></ul><p>这一版本的优化只对 RevokePartitions 发生影响。对比以前的设计，一旦进入 JoinGroup，所有 consumer 都要停止处理、commit offset。</p><h1 id="Design-II-Deferred-Resolution-of-Imbalance"><a href="#Design-II-Deferred-Resolution-of-Imbalance" class="headerlink" title="Design II: Deferred Resolution of Imbalance"></a>Design II: Deferred Resolution of Imbalance</h1><blockquote><p>we should schedule another rebalance instead of always trying to resolve imbalance immediately.</p></blockquote><p>在 Design 1 的基础上，在 assignment 增加 ScheduledRebalanceTimeout，延迟处理不平衡状态。</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Assignment (Leader → Member):</span><br><span class="line"></span><br><span class="line">Assignment =&gt; Version AssignedTopicPartitions RevokeTopicPartitions ScheduledRebalanceTimeout</span><br><span class="line">  Version                      =&gt; int16</span><br><span class="line">  AssignedTopicPartitions      =&gt; [Topic Partitions]</span><br><span class="line">    Topic         =&gt; String</span><br><span class="line">    Partitions    =&gt; [int32]</span><br><span class="line">  RevokeTopicPartitions        =&gt; [Topic Partitions]</span><br><span class="line">    Topic         =&gt; String</span><br><span class="line">    Partitions    =&gt; [int32]</span><br><span class="line">  ScheduledRebalanceTimeout    =&gt; int32</span><br></pre></td></tr></table></figure></div><p>新增配置：</p><ul><li><code>scheduled.rebalance.max.delay.ms</code>(默认 5min)。对应上面的 ScheduledRebalanceTimeout。</li></ul><p>member 进程：</p><ul><li>如果 <code>ScheduledRebalanceTimeout &gt; 0</code>，则在超时之后尽快 rejoin（RevokePartitions 字段为空才设置该字段）。</li></ul><blockquote><p>As long as this delay is active, the lost tasks remain unassigned. This gives the departing worker (or its replacement) some time to return to the group. Once that happens, a second rebalance is triggered, but the lost tasks remain unassigned until the scheduled rebalance delay expires.</p></blockquote><p><code>scheduled.rebalance.max.delay.ms</code> 允许延迟若干时间才触发 rebalance，在这期间部分任务未被分配。离开的 worker 有机会在这时间内重新加入 group。<strong>当超时发生，再触发一次 rebalance</strong>。这样设计是期望原来 worker 能够及时 rejoin，再下一次 rebalance 就不需要 revoke partition。</p><p>kafka 0.11 增加了配置：<code>group.initial.rebalance.delay.ms</code>，作用是类似的，但是只应用于空组。ScheduledRebalanceTimeout 应用场景更广。</p><h1 id="Design-III-Incremental-Resolution-of-Imbalance"><a href="#Design-III-Incremental-Resolution-of-Imbalance" class="headerlink" title="Design III: Incremental Resolution of Imbalance"></a>Design III: Incremental Resolution of Imbalance</h1><p>在 Design 2 的基础上，允许 leader 以多次迭代、每次只重新分配部分分区的方式、实现 rebalance。</p><h1 id="协议配置选项"><a href="# 协议配置选项" class="headerlink" title="协议配置选项"></a>协议配置选项</h1><p>增加 <code>connect.protocol</code> 选项：</p><blockquote><p>Values: eager, compatible<br>Default: compatible<br>This property defines which Connect protocol is enabled.</p><ul><li>eager corresponds to the initial non-cooperative protocol that resolves imbalance with an immediate redistribution of connectors and tasks (version 0).</li><li>compatible corresponds to both eager (protocol version 0) and incremental cooperative (protocol version 1 or higher) protocols being enabled with the incremental cooperative protocol being preferred if both are supported (version 1 or version 0).</li></ul></blockquote><h1 id="小结"><a href="# 小结" class="headerlink" title="小结"></a>小结</h1><p>kafka 2.3 的增量协同平衡优化：</p><ul><li>member 进入 JoinGroup 状态，继续持有资源。只对 RevokePartitions 释放资源。</li><li>对于 RevokePartitions，不是立即释放，而是等待 <code>scheduled.rebalance.max.delay.ms</code>，让离开的 worker 有机会 rejoin。发生超时后再触发 rebalance。</li><li><code>scheduled.rebalance.max.delay.ms</code> 是<code>group.initial.rebalance.delay.ms</code>的升级</li></ul><h1 id="参考"><a href="# 参考" class="headerlink" title="参考"></a> 参考</h1><ul><li><a href="https://cwiki.apache.org/confluence/display/KAFKA/Incremental+Cooperative+Rebalancing:+Support+and+Policies" rel="external nofollow noopener noreferrer" target="_blank">Incremental Cooperative Rebalancing: Support and Policies</a></li><li><a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-415%3A+Incremental+Cooperative+Rebalancing+in+Kafka+Connect" rel="external nofollow noopener noreferrer" target="_blank">KIP-415: Incremental Cooperative Rebalancing in Kafka Connect</a></li><li><a href="https://medium.com/streamthoughts/apache-kafka-rebalance-protocol-or-the-magic-behind-your-streams-applications-e94baf68e4f2" rel="external nofollow noopener noreferrer" target="_blank">Apache Kafka Rebalance Protocol, or the magic behind your streams applications</a></li></ul><h1>题外话</h1><p style="text-align:center;font-size:14px">&#x672C;&#x6587;&#x4F5C;&#x8005;ycwu314，&#x672A;&#x7ECF;&#x5141;&#x8BB8;&#x8BF7;&#x52FF;&#x8F6C;&#x8F7D; <a href="https://ycwu314.cloud/p/kafka-rebalance-p4/">kafka rebalance 系列：incremental cooperative rebalancing</a> : https://ycwu314.cloud/p/kafka-rebalance-p4/</p><p style="text-align:center;font-size:16px;font-weight:700">你的支持将鼓励我继续更多原创分享！</p><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="https://s2.ax1x.com/2019/08/12/ezfUk8.jpg" style="width:50%;margin:0 auto"></div><div class="popular-posts-header">相关文章</div><ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><a href="/p/kafka-open-files-limits/" rel="bookmark">kafka：解决 too many open files</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/p/kafka-rebalance-p3/" rel="bookmark">kafka rebalance 系列：static membership 优化</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/p/kafka-rebalance-p2/" rel="bookmark">kafka rebalance 系列：空消费者组优化</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/p/kafka-rebalance-p1/" rel="bookmark">kafka rebalance 系列：KIP-62 max.poll.interval.ms</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/p/kafka-consumers-reconume-offsets-after-long-time-shutdown/" rel="bookmark">kafka 消费者停机重启后重新消费 offset 的 case</a></div></li></ul><div><div id="reward-container"><div>你的支持将鼓励我继续更多原创分享！</div><button id="reward-button" disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">打赏</button><div id="qr" style="display:none"><div style="display:inline-block"><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="https://s2.ax1x.com/2019/08/12/ezfUk8.jpg" alt="ycwu314 微信支付"><p>微信支付</p></div></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者： </strong>ycwu314</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://ycwu314.cloud/p/kafka-rebalance-p4/" title="kafka rebalance 系列：incremental cooperative rebalancing">https://ycwu314.cloud/p/kafka-rebalance-p4/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均为原创文章，未经允许请勿转载！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/t/kafka/" rel="tag"># kafka</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/p/kafka-rebalance-p3/" rel="next" title="kafka rebalance 系列：static membership 优化"><i class="fa fa-chevron-left"></i> kafka rebalance 系列：static membership 优化</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/p/kafka-open-files-limits/" rel="prev" title="kafka：解决 too many open files">kafka：解决 too many open files <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/avatar.webp" alt="ycwu314"><p class="site-author-name" itemprop="name">ycwu314</p><div class="site-description motion-element" itemprop="description">java, 微服务, 分布式系统, 架构设计</div></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/arch"><span class="site-state-item-count">268</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/c/"><span class="site-state-item-count">57</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/t/"><span class="site-state-item-count">99</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/ycwu314" title="GitHub &rarr; https://github.com/ycwu314" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:ycwu314@foxmail.com" title="E-Mail &rarr; mailto:ycwu314@foxmail.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div></div></div><div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Incremental-Cooperative-Rebalancing"><span class="nav-number">1.</span> <span class="nav-text">Incremental Cooperative Rebalancing</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Design-I-Simple-Cooperative-Rebalancing"><span class="nav-number">2.</span> <span class="nav-text">Design I: Simple Cooperative Rebalancing</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Design-II-Deferred-Resolution-of-Imbalance"><span class="nav-number">3.</span> <span class="nav-text">Design II: Deferred Resolution of Imbalance</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Design-III-Incremental-Resolution-of-Imbalance"><span class="nav-number">4.</span> <span class="nav-text">Design III: Incremental Resolution of Imbalance</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#协议配置选项"><span class="nav-number">5.</span> <span class="nav-text">协议配置选项</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#小结"><span class="nav-number">6.</span> <span class="nav-text">小结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考"><span class="nav-number">7.</span> <span class="nav-text">参考</span></a></li></ol></div></div></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2020</span> <span class="with-love" id="animate"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">ycwu314</span> <span class="post-meta-divider">|</span> <span class="post-count">共&nbsp;275.1k&nbsp;字</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/velocity/1.2.1/velocity.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/velocity/1.2.1/velocity.ui.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.6/jquery.fancybox.min.js"></script><script src="/js/utils.js?v=7.1.2"></script><script src="/js/motion.js?v=7.1.2"></script><script src="/js/schemes/muse.js?v=7.1.2"></script><script src="/js/scrollspy.js?v=7.1.2"></script><script src="/js/post-details.js?v=7.1.2"></script><script src="/js/next-boot.js?v=7.1.2"></script><script>function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var e=$("#local-search-input");e.attr("autocapitalize","none"),e.attr("autocorrect","off"),e.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(e){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(e,t,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:e,dataType:isXml?"xml":"json",async:!0,success:function(e){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",e).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():e,r=document.getElementById(t),s=document.getElementById(o),a=function(){var e=r.value.trim().toLowerCase(),t=e.split(/[\s\-]+/);t.length>1&&t.push(e);var o=[];if(e.length>0&&n.forEach(function(n){function r(t,o,n,r){for(var s=r[r.length-1],a=s.position,i=s.word,l=[],h=0;a+i.length<=n&&0!=r.length;){i===e&&h++,l.push({position:a,length:i.length});var p=a+i.length;for(r.pop();0!=r.length&&(s=r[r.length-1],a=s.position,i=s.word,p>a);)r.pop()}return c+=h,{hits:l,start:o,end:n,searchTextCount:h}}function s(e,t){var o="",n=t.start;return t.hits.forEach(function(t){o+=e.substring(n,t.position);var r=t.position+t.length;o+='<b class="search-keyword">'+e.substring(t.position,r)+"</b>",n=r}),o+=e.substring(n,t.end)}var a=!1,i=0,c=0,l=n.title.trim(),h=l.toLowerCase(),p=n.content.trim().replace(/<[^>]+>/g,""),u=p.toLowerCase(),f=decodeURIComponent(n.url).replace(/\/{2,}/g,"/"),d=[],g=[];if(""!=l&&(t.forEach(function(e){function t(e,t,o){var n=e.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(t=t.toLowerCase(),e=e.toLowerCase());(s=t.indexOf(e,r))>-1;)a.push({position:s,word:e}),r=s+n;return a}d=d.concat(t(e,h,!1)),g=g.concat(t(e,u,!1))}),(d.length>0||g.length>0)&&(a=!0,i=d.length+g.length)),a){[d,g].forEach(function(e){e.sort(function(e,t){return t.position!==e.position?t.position-e.position:e.word.length-t.word.length})});var v=[];0!=d.length&&v.push(r(l,0,l.length,d));for(var $=[];0!=g.length;){var C=g[g.length-1],m=C.position,x=C.word,w=m-20,y=m+80;0>w&&(w=0),y<m+x.length&&(y=m+x.length),y>p.length&&(y=p.length),$.push(r(p,w,y,g))}$.sort(function(e,t){return e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hits.length!==t.hits.length?t.hits.length-e.hits.length:e.start-t.start});var T=parseInt("1");T>=0&&($=$.slice(0,T));var b="";b+=0!=v.length?"<li><a href='"+f+"' class='search-result-title'>"+s(l,v[0])+"</a>":"<li><a href='"+f+"' class='search-result-title'>"+l+"</a>",$.forEach(function(e){b+="<a href='"+f+'\'><p class="search-result">'+s(p,e)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:c,hitCount:i,id:o.length})}}),1===t.length&&""===t[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x"></i></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>';else{o.sort(function(e,t){return e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hitCount!==t.hitCount?t.hitCount-e.hitCount:t.id-e.id});var a='<ul class="search-result-list">';o.forEach(function(e){a+=e.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(e){e.stopPropagation(),isfetched===!1?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(e){e.stopPropagation()}),$(document).on("keyup",function(e){var t=27===e.which&&$(".search-popup").is(":visible");t&&onPopupClose()})</script><script>!function(t){function n(){for(var n=0;n<e.length;n++)i=e[n],0<=(o=i.getBoundingClientRect()).top&&0<=o.left&&o.top<=(t.innerHeight||document.documentElement.clientHeight)&&function(){var t,i,o,c,r=e[n];t=r,i=function(){e=e.filter(function(t){return r!==t})},o=new Image,c=t.getAttribute("data-original"),o.onload=function(){t.src=c,i&&i()},o.src=c}();var i,o}var e=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));n(),t.addEventListener("scroll",function(){!function(t,n){clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)}(n,t)})}(this)</script></body></html><!-- rebuild by neat -->