<!-- build time:Thu Dec 24 2020 16:28:50 GMT+0800 (China Standard Time) --><!DOCTYPE html><html class="theme-next mist use-motion" lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="keywords" content="java,微服务,分布式系统,架构设计"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.6/jquery.fancybox.min.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.2/css/font-awesome.min.css"><link rel="stylesheet" href="/css/main.css?v=7.1.2"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.2"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.2"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.2"><link rel="mask-icon" href="/images/logo.svg?v=7.1.2" color="#222"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",version:"7.1.2",sidebar:{position:"left",display:"hide",offset:12,onmobile:!1,dimmer:!1},back2top:!0,back2top_sidebar:!1,fancybox:!0,fastclick:!1,lazyload:!1,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta name="description" content="使用wireshark对tls握手过程抓包。change cipher spec发生在双方。encrypted handshake message阶段表明握手结束，发送验证消息。"><meta name="keywords" content="tls 抓包,encrypted handshake message,change cipher spec"><meta property="og:type" content="article"><meta property="og:title" content="使用 wireshark 抓包 tls 1.2 握手"><meta property="og:url" content="https://ycwu314.cloud/p/tls-handshake-wireshark-capture/index.html"><meta property="og:site_name" content="ycwu314"><meta property="og:description" content="使用wireshark对tls握手过程抓包。change cipher spec发生在双方。encrypted handshake message阶段表明握手结束，发送验证消息。"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://ycwu314.cloud/p/tls-handshake-wireshark-capture/v2_baidu_handshake_capture.webp"><meta property="og:image" content="https://ycwu314.cloud/p/tls-handshake-wireshark-capture/v2_client_hello.webp"><meta property="og:image" content="https://ycwu314.cloud/p/tls-handshake-wireshark-capture/v2_client_hello_extension.webp"><meta property="og:image" content="https://ycwu314.cloud/p/tls-handshake-wireshark-capture/v2_server_hello.webp"><meta property="og:image" content="https://ycwu314.cloud/p/tls-handshake-wireshark-capture/v2_server_hello_certificate.webp"><meta property="og:image" content="https://ycwu314.cloud/p/tls-handshake-wireshark-capture/v2_server_hello_certificate_detail.webp"><meta property="og:image" content="https://ycwu314.cloud/p/tls-handshake-wireshark-capture/v2_server_key_exchange.webp"><meta property="og:image" content="https://ycwu314.cloud/p/tls-handshake-wireshark-capture/v2_server_hello_done.webp"><meta property="og:image" content="https://ycwu314.cloud/p/tls-handshake-wireshark-capture/v2_client_exchange.webp"><meta property="og:image" content="https://ycwu314.cloud/p/tls-handshake-wireshark-capture/v2_client_key_exchange_dh_param.webp"><meta property="og:image" content="https://ycwu314.cloud/p/tls-handshake-wireshark-capture/v2_change_cipher_spec.webp"><meta property="og:image" content="https://ycwu314.cloud/p/tls-handshake-wireshark-capture/v2_change_cipher_spec_overview.webp"><meta property="og:image" content="https://ycwu314.cloud/p/tls-handshake-wireshark-capture/v2_encrypt_handshake_message.webp"><meta property="og:image" content="https://ycwu314.cloud/p/tls-handshake-wireshark-capture/v2_new_session_ticket.webp"><meta property="og:image" content="https://ycwu314.cloud/p/tls-handshake-wireshark-capture/v2_application_data.webp"><meta property="og:image" content="https://ycwu314.cloud/p/tls-handshake-wireshark-capture/v2_tcp_spurious_retransimission.webp"><meta property="og:updated_time" content="2020-12-24T08:27:14.369Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="使用 wireshark 抓包 tls 1.2 握手"><meta name="twitter:description" content="使用wireshark对tls握手过程抓包。change cipher spec发生在双方。encrypted handshake message阶段表明握手结束，发送验证消息。"><meta name="twitter:image" content="https://ycwu314.cloud/p/tls-handshake-wireshark-capture/v2_baidu_handshake_capture.webp"><link rel="canonical" href="https://ycwu314.cloud/p/tls-handshake-wireshark-capture/"><script id="page.configurations">CONFIG.page={sidebar:""}</script><title>使用 wireshark 抓包 tls 1.2 握手 | ycwu314</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">ycwu314</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">潮的工地</h1></div><div class="site-nav-toggle"><button aria-label="切换导航栏"><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-collection"><a href="/collection" rel="section"><i class="menu-item-icon fa fa-fw fa-file-code-o"></i><br>专题</a></li><li class="menu-item menu-item-tags"><a href="/t/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://ycwu314.cloud/p/tls-handshake-wireshark-capture/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="ycwu314"><meta itemprop="description" content="java, 微服务, 分布式系统, 架构设计"><meta itemprop="image" content="/images/avatar.webp"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="ycwu314"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">使用 wireshark 抓包 tls 1.2 握手</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-08-09 17:12:00" itemprop="dateCreated datePublished" datetime="2019-08-09T17:12:00+08:00">2019-08-09</time> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2020-12-24 16:27:14" itemprop="dateModified" datetime="2020-12-24T16:27:14+08:00">2020-12-24</time> </span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/c/https/" itemprop="url" rel="index"><span itemprop="name">https</span></a></span></span><br><span title="post.wordcount">共&nbsp;1.2k&nbsp;字 <span class="post-meta-divider">|</span> </span><span title="post.min2read">阅读时间&nbsp;5&nbsp;分钟</span><div class="post-description">使用wireshark对tls握手过程抓包。change cipher spec发生在双方。encrypted handshake message阶段表明握手结束，发送验证消息。</div></div></header><div class="post-body" itemprop="articleBody"><p style="text-align:center;font-size:14px">本文作者ycwu314，未经允许请勿转载 <a href="https://ycwu314.cloud/p/tls-handshake-wireshark-capture/">使用 wireshark 抓包 tls 1.2 握手</a> : https://ycwu314.cloud/p/tls-handshake-wireshark-capture/<br>&#x6E29;&#x99A8;&#x63D0;&#x793A;&#xFF1A;&#x5982;&#x679C;&#x4E0D;&#x662F;&#x5728;&#x8FD9;&#x4E9B;&#x5730;&#x65B9;&#x770B;&#x5230;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#xFF0C;&#x90A3;&#x4E48;&#x4F60;&#x53EF;&#x80FD;&#x662F;&#x722C;&#x866B;&#x6587;&#x7AE0;&#x7684;&#x53D7;&#x5BB3;&#x8005;&#xFF1A;<br>https://ycwu314.top/ (原https://ycwu314.github.io/)<br>&#x672A;&#x7ECF;&#x6388;&#x6743;&#x7684;&#x8F6C;&#x8F7D;&#xFF0C;&#x4E0D;&#x4EC5;&#x6253;&#x51FB;&#x539F;&#x521B;&#x79EF;&#x6781;&#x6027;&#xFF0C;&#x8FD8;&#x83B7;&#x53D6;&#x4E0D;&#x5230;&#x6700;&#x65B0;&#x7684;&#x6587;&#x7AE0;&#x66F4;&#x65B0;&#x4FE1;&#x606F;&#x3002;</p><h1 id="前言"><a href="# 前言" class="headerlink" title="前言"></a>前言</h1><p>上次聊了 tls 1.2 握手流程，内容比较多，缺乏具体的例子</p><ul><li><a href="/p/tls-handshake-v-1-2/" title="https tls v1.2 握手过程">https tls v1.2 握手过程</a></li></ul><p>这次以访问 baidu 首页为例，使用 wireshark 抓包，对其中的步骤进行观察。无图无真相，先上图，点击放大。</p><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="/p/tls-handshake-wireshark-capture/v2_baidu_handshake_capture.webp" title="tls 握手抓包"><a id="more"></a><h1 id="查询 dns"><a href="# 查询 dns" class="headerlink" title="查询 dns"></a>查询 dns</h1><p>为了方便，关闭了浏览器，使用 <code>curl</code> 发起网络请求。</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="BASH"><figure class="iseeu highlight /bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl https://www.baidu.com</span><br></pre></td></tr></table></figure></div><p>seq=9，发起了 dns 查询。<br>seq=10，dns 服务器返回了 baidu.com 的 ip 地址。</p><h1 id="tcp 三次握手"><a href="#tcp 三次握手" class="headerlink" title="tcp 三次握手"></a>tcp 三次握手</h1><p>接下来 3 个数据包是熟悉的建立 tcp 连接三次握手。<br>seq=11，本机向 baidu 服务器发起 tcp 请求。发送的 syn 包。<br>seq=12，baidu 服务器向本机回应 syn ack 包。<br>seq=13，本机发送 ack，正式建立 tcp 连接。</p><h1 id="client-hello"><a href="#client-hello" class="headerlink" title="client hello"></a>client hello</h1><p>从第 14 个包开始，正式进入 tls 握手阶段。留意 protocol=TLSv1.2。</p><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="/p/tls-handshake-wireshark-capture/v2_client_hello.webp" title="client hello"><p>核心的字段是 TLS 版本，client random，客户端支持的 cipher suites。<br>还有其他扩展字段，比如之前提到的 SNI，签名算法等。</p><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="/p/tls-handshake-wireshark-capture/v2_client_hello_extension.webp" title="client hello extension"><h1 id="server-hello"><a href="#server-hello" class="headerlink" title="server hello"></a>server hello</h1><p>第 16 个包开始是 server hello 阶段。</p><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="/p/tls-handshake-wireshark-capture/v2_server_hello.webp" title="server hello"><p>首先发送 server random，以及协商使用的 cipher suite</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cipher Suite: TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 (0xc02f)</span><br></pre></td></tr></table></figure></div><p><code>TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256</code>的意义是:</p><ul><li>TLS：SSL/TLS 协议</li><li>ECDHE：key exchange 算法</li><li>RSA：authentication 算法</li><li>AES_128_GCM：encryptation 算法</li><li>SHA256： MAC 算法，用于创建消息摘要。后面的 encrypted handshake message 阶段用到。</li></ul><p>第 20 个包发送了服务器证书。注意这里是 2 个证书，是 baidu 的证书，以及签发 baidu 的上级机构的证书</p><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="/p/tls-handshake-wireshark-capture/v2_server_hello_certificate.webp" title="server hello certificate"><p>打开 baidu 的证书。</p><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="/p/tls-handshake-wireshark-capture/v2_server_hello_certificate_detail.webp" title="server hello certificate"><p>可以看到几个关键信息：</p><ol><li>这个证书的制作，<code>sha256WithRSAEncryption</code>，sha256 是验签方式，使用的非对称加密方式是 RSA</li><li><code>validity</code>记录证书的有效期</li><li>这个证书的公钥 public key</li></ol><h1 id="server-key-exchange"><a href="#server-key-exchange" class="headerlink" title="server key exchange"></a>server key exchange</h1><p>第 20 个包有意思。</p><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="/p/tls-handshake-wireshark-capture/v2_server_key_exchange.webp" title="server key exchange"><p>上个文章提到，tls 握手有 2 种模式：RSA 握手、DH 握手。这里再重复一下。<br>RSA 握手模式，client 自己生成 premaster secret，并且使用证书的 public key 去加密，再发送给 server。一旦服务器私钥泄露，未来所有的 tls 握手都不安全了。<br>DH 握手模式，premaster secret 由 client、server 根据 DH parameter 协商生成，安全性更高。</p><p>从抓包情况看，baidu 使用了 DH 握手模式了。使用 ECDH，返回了 server dh param。</p><h1 id="server-hello-done"><a href="#server-hello-done" class="headerlink" title="server hello done"></a>server hello done</h1><p>这个包很简单，没什么好说的。</p><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="/p/tls-handshake-wireshark-capture/v2_server_hello_done.webp" title="server hello done"><h1 id="client-exchange 阶段"><a href="#client-exchange 阶段" class="headerlink" title="client exchange 阶段"></a>client exchange 阶段</h1><p>第 24 个数据包内容很丰富。</p><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="/p/tls-handshake-wireshark-capture/v2_client_exchange.webp" title="client exchange"><h2 id="client-key-exchange"><a href="#client-key-exchange" class="headerlink" title="client key exchange"></a>client key exchange</h2><p>因为使用 DH 模式握手，client 要回复它生产的 client dh param</p><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="/p/tls-handshake-wireshark-capture/v2_client_key_exchange_dh_param.webp" title="client exchange"><h2 id="change-cipher-spec（client）"><a href="#change-cipher-spec（client）" class="headerlink" title="change cipher spec（client）"></a>change cipher spec（client）</h2><p>这个包只有一个字节，但是干嘛呢？</p><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="/p/tls-handshake-wireshark-capture/v2_change_cipher_spec.webp" title="change cipher spec"><p>发现对这个数据包理解不到位，最后找到 Cisco 的一篇文章：<a href="https://www.cisco.com/c/en/us/support/docs/security-vpn/secure-socket-layer-ssl/116181-technote-product-00.html" rel="external nofollow noopener noreferrer" target="_blank">SSL Introduction with Sample Transaction and Packet Exchange</a></p><blockquote><p>The message is sent by both the client and server in order to notify the receiving party that subsequent records are protected under the most recently negotiated Cipher Spec and keys.</p></blockquote><ol><li>client 和 server 都会发送 <code>change cipher spec</code> 报文 <img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="/p/tls-handshake-wireshark-capture/v2_change_cipher_spec_overview.webp" title="change cipher spec"></li><li>这个报文的意义是，通知对方，使用最近协商的 cipher 和 key，并且后续的报文都是加密的。<img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="/p/tls-handshake-wireshark-capture/v2_encrypt_handshake_message.webp" title="encrypt handshake message"></li></ol><h2 id="encrypted-handshake-message"><a href="#encrypted-handshake-message" class="headerlink" title="encrypted handshake message"></a>encrypted handshake message</h2><p>tls 握手成功之后，双方都会发送一条 <code>encrypted handshake message</code> 报文。这个报文的作用是校验握手是否成功，数据没有被中间人篡改。</p><blockquote><p>Both client and server send the Finished message but the first to do it is the client. If the server receives the message and could decrypt and understand it, it means the the server is reading the encrypted information in the right way. Now the only missing part is that client could decrypt the information sent by the server. To do that the server must send a Change Cipher Spec message too followed by the Finished message in the encrypted way. Exactly the same as client did. Again if the client could decrypt the Finished message it means that both parties are in frequency and they can talk to each other protecting all the data in transit.</p></blockquote><ol><li>client 和 server 都会发送这个报文，但是首先由 client 发送</li><li>发送的内容是什么呢，又是怎么验证？查到一个文章，讲的清楚 <a href="https://medium.com/@ethicalevil/tls-handshake-protocol-overview-a39e8eee2cf5" rel="external nofollow noopener noreferrer" target="_blank">TLS v1.2 handshake overview - apoorv munshi - Medium</a></li></ol><p>这个消息体的内容是一个 hash，哈希方法使用的是 server hello 协商的 <code>TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256</code> 中的 SHA256。哈希的内容是</p><ul><li>master_secret</li><li>hash of all the previous handshake messages (from ClientHello up to Finished message, not including this Finished Message)</li><li>finished_label string (“client finished” for client message and “server finished” for server message)<div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">verify_data</span><br><span class="line">         PRF(master_secret, finished_label, Hash(handshake_messages))</span><br><span class="line">(quoted from section 7.4.9 of RFC 5246)</span><br></pre></td></tr></table></figure></div></li></ul><p>对方用同样方式计算，如果和哈希值一致，则表明安全建立加密通信。</p><h1 id="new-session-ticket"><a href="#new-session-ticket" class="headerlink" title="new session ticket"></a>new session ticket</h1><p>server 生成会话 id。</p><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="/p/tls-handshake-wireshark-capture/v2_new_session_ticket.webp" title="new session ticket"><h1 id="change-cipher-spec（server）"><a href="#change-cipher-spec（server）" class="headerlink" title="change cipher spec（server）"></a>change cipher spec（server）</h1><p>类似上面 client 的 change cipher spec，不重复了。</p><h1 id="application-data"><a href="#application-data" class="headerlink" title="application data"></a>application data</h1><p>从这个阶段开始，client 和 server 使用 session key 加密、解密数据通信。</p><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="/p/tls-handshake-wireshark-capture/v2_application_data.webp" title="application data"><h1 id="其他：-TCP-Spurious-Retransmissions"><a href="# 其他：-TCP-Spurious-Retransmissions" class="headerlink" title="其他：[TCP Spurious Retransmissions]"></a>其他：[TCP Spurious Retransmissions]</h1><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="/p/tls-handshake-wireshark-capture/v2_tcp_spurious_retransimission.webp" title="tcp spurious retransimission"><p><code>spurious</code>的意思是虚假的。baidu 服务器认为可能发生超时或者丢包，提前发起重传。具体以后再研究。</p><h1>题外话</h1><p style="text-align:center;font-size:14px">&#x672C;&#x6587;&#x4F5C;&#x8005;ycwu314，&#x672A;&#x7ECF;&#x5141;&#x8BB8;&#x8BF7;&#x52FF;&#x8F6C;&#x8F7D; <a href="https://ycwu314.cloud/p/tls-handshake-wireshark-capture/">使用 wireshark 抓包 tls 1.2 握手</a> : https://ycwu314.cloud/p/tls-handshake-wireshark-capture/</p><p style="text-align:center;font-size:16px;font-weight:700">你的支持将鼓励我继续更多原创分享！</p><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="https://s2.ax1x.com/2019/08/12/ezfUk8.jpg" style="width:50%;margin:0 auto"></div><div class="popular-posts-header">相关文章</div><ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><a href="/p/use-nginx-stream-module-as-ssh-tunnel/" rel="bookmark">使用 nginx stream 模块做端口转发</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/p/git-batch-delete-tags/" rel="bookmark">批量删除 git 标签</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/p/kubernetes-yaml-command-args-redirect/" rel="bookmark">kubernetes yaml 中 command 重定向的写法</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/p/travis-ci-speed-up-building-with-cache/" rel="bookmark">Travis CI 使用 cache 加速构建</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/p/hexo-image-title-alt/" rel="bookmark">修改 hexo image title alt</a></div></li></ul><div><div id="reward-container"><div>你的支持将鼓励我继续更多原创分享！</div><button id="reward-button" disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">打赏</button><div id="qr" style="display:none"><div style="display:inline-block"><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="https://s2.ax1x.com/2019/08/12/ezfUk8.jpg" alt="ycwu314 微信支付"><p>微信支付</p></div></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者： </strong>ycwu314</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://ycwu314.cloud/p/tls-handshake-wireshark-capture/" title="使用 wireshark 抓包 tls 1.2 握手">https://ycwu314.cloud/p/tls-handshake-wireshark-capture/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均为原创文章，未经允许请勿转载！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/t/技巧/" rel="tag"># 技巧</a> <a href="/t/https/" rel="tag"># https</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/p/tls-handshake-v-1-2/" rel="next" title="https tls v1.2 握手过程"><i class="fa fa-chevron-left"></i> https tls v1.2 握手过程</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/p/https-sni-nginx-config/" rel="prev" title="nginx 配置多个 TLS 证书，以及 TLS SNI 简介">nginx 配置多个 TLS 证书，以及 TLS SNI 简介 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/avatar.webp" alt="ycwu314"><p class="site-author-name" itemprop="name">ycwu314</p><div class="site-description motion-element" itemprop="description">java, 微服务, 分布式系统, 架构设计</div></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/arch"><span class="site-state-item-count">268</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/c/"><span class="site-state-item-count">57</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/t/"><span class="site-state-item-count">99</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/ycwu314" title="GitHub &rarr; https://github.com/ycwu314" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:ycwu314@foxmail.com" title="E-Mail &rarr; mailto:ycwu314@foxmail.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div></div></div><div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#查询 dns"><span class="nav-number">2.</span> <span class="nav-text">查询 dns</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#tcp 三次握手"><span class="nav-number">3.</span> <span class="nav-text">tcp 三次握手</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#client-hello"><span class="nav-number">4.</span> <span class="nav-text">client hello</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#server-hello"><span class="nav-number">5.</span> <span class="nav-text">server hello</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#server-key-exchange"><span class="nav-number">6.</span> <span class="nav-text">server key exchange</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#server-hello-done"><span class="nav-number">7.</span> <span class="nav-text">server hello done</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#client-exchange 阶段"><span class="nav-number">8.</span> <span class="nav-text">client exchange 阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#client-key-exchange"><span class="nav-number">8.1.</span> <span class="nav-text">client key exchange</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#change-cipher-spec（client）"><span class="nav-number">8.2.</span> <span class="nav-text">change cipher spec（client）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#encrypted-handshake-message"><span class="nav-number">8.3.</span> <span class="nav-text">encrypted handshake message</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#new-session-ticket"><span class="nav-number">9.</span> <span class="nav-text">new session ticket</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#change-cipher-spec（server）"><span class="nav-number">10.</span> <span class="nav-text">change cipher spec（server）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#application-data"><span class="nav-number">11.</span> <span class="nav-text">application data</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#其他：-TCP-Spurious-Retransmissions"><span class="nav-number">12.</span> <span class="nav-text">其他：[TCP Spurious Retransmissions]</span></a></li></ol></div></div></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2020</span> <span class="with-love" id="animate"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">ycwu314</span> <span class="post-meta-divider">|</span> <span class="post-count">共&nbsp;275.1k&nbsp;字</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/velocity/1.2.1/velocity.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/velocity/1.2.1/velocity.ui.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.6/jquery.fancybox.min.js"></script><script src="/js/utils.js?v=7.1.2"></script><script src="/js/motion.js?v=7.1.2"></script><script src="/js/schemes/muse.js?v=7.1.2"></script><script src="/js/scrollspy.js?v=7.1.2"></script><script src="/js/post-details.js?v=7.1.2"></script><script src="/js/next-boot.js?v=7.1.2"></script><script>function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var e=$("#local-search-input");e.attr("autocapitalize","none"),e.attr("autocorrect","off"),e.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(e){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(e,t,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:e,dataType:isXml?"xml":"json",async:!0,success:function(e){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",e).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():e,r=document.getElementById(t),s=document.getElementById(o),a=function(){var e=r.value.trim().toLowerCase(),t=e.split(/[\s\-]+/);t.length>1&&t.push(e);var o=[];if(e.length>0&&n.forEach(function(n){function r(t,o,n,r){for(var s=r[r.length-1],a=s.position,i=s.word,l=[],h=0;a+i.length<=n&&0!=r.length;){i===e&&h++,l.push({position:a,length:i.length});var p=a+i.length;for(r.pop();0!=r.length&&(s=r[r.length-1],a=s.position,i=s.word,p>a);)r.pop()}return c+=h,{hits:l,start:o,end:n,searchTextCount:h}}function s(e,t){var o="",n=t.start;return t.hits.forEach(function(t){o+=e.substring(n,t.position);var r=t.position+t.length;o+='<b class="search-keyword">'+e.substring(t.position,r)+"</b>",n=r}),o+=e.substring(n,t.end)}var a=!1,i=0,c=0,l=n.title.trim(),h=l.toLowerCase(),p=n.content.trim().replace(/<[^>]+>/g,""),u=p.toLowerCase(),f=decodeURIComponent(n.url).replace(/\/{2,}/g,"/"),d=[],g=[];if(""!=l&&(t.forEach(function(e){function t(e,t,o){var n=e.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(t=t.toLowerCase(),e=e.toLowerCase());(s=t.indexOf(e,r))>-1;)a.push({position:s,word:e}),r=s+n;return a}d=d.concat(t(e,h,!1)),g=g.concat(t(e,u,!1))}),(d.length>0||g.length>0)&&(a=!0,i=d.length+g.length)),a){[d,g].forEach(function(e){e.sort(function(e,t){return t.position!==e.position?t.position-e.position:e.word.length-t.word.length})});var v=[];0!=d.length&&v.push(r(l,0,l.length,d));for(var $=[];0!=g.length;){var C=g[g.length-1],m=C.position,x=C.word,w=m-20,y=m+80;0>w&&(w=0),y<m+x.length&&(y=m+x.length),y>p.length&&(y=p.length),$.push(r(p,w,y,g))}$.sort(function(e,t){return e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hits.length!==t.hits.length?t.hits.length-e.hits.length:e.start-t.start});var T=parseInt("1");T>=0&&($=$.slice(0,T));var b="";b+=0!=v.length?"<li><a href='"+f+"' class='search-result-title'>"+s(l,v[0])+"</a>":"<li><a href='"+f+"' class='search-result-title'>"+l+"</a>",$.forEach(function(e){b+="<a href='"+f+'\'><p class="search-result">'+s(p,e)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:c,hitCount:i,id:o.length})}}),1===t.length&&""===t[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x"></i></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>';else{o.sort(function(e,t){return e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hitCount!==t.hitCount?t.hitCount-e.hitCount:t.id-e.id});var a='<ul class="search-result-list">';o.forEach(function(e){a+=e.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(e){e.stopPropagation(),isfetched===!1?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(e){e.stopPropagation()}),$(document).on("keyup",function(e){var t=27===e.which&&$(".search-popup").is(":visible");t&&onPopupClose()})</script><script>!function(t){function n(){for(var n=0;n<e.length;n++)i=e[n],0<=(o=i.getBoundingClientRect()).top&&0<=o.left&&o.top<=(t.innerHeight||document.documentElement.clientHeight)&&function(){var t,i,o,c,r=e[n];t=r,i=function(){e=e.filter(function(t){return r!==t})},o=new Image,c=t.getAttribute("data-original"),o.onload=function(){t.src=c,i&&i()},o.src=c}();var i,o}var e=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));n(),t.addEventListener("scroll",function(){!function(t,n){clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)}(n,t)})}(this)</script></body></html><!-- rebuild by neat -->