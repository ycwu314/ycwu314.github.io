<!-- build time:Thu Dec 24 2020 16:28:33 GMT+0800 (China Standard Time) --><!DOCTYPE html><html class="theme-next mist use-motion" lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="keywords" content="java,微服务,分布式系统,架构设计"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.6/jquery.fancybox.min.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.2/css/font-awesome.min.css"><link rel="stylesheet" href="/css/main.css?v=7.1.2"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.2"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.2"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.2"><link rel="mask-icon" href="/images/logo.svg?v=7.1.2" color="#222"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",version:"7.1.2",sidebar:{position:"left",display:"hide",offset:12,onmobile:!1,dimmer:!1},back2top:!0,back2top_sidebar:!1,fancybox:!0,fastclick:!1,lazyload:!1,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta name="description" content="vlan学习笔记"><meta name="keywords" content="vlan,三层交换机"><meta property="og:type" content="article"><meta property="og:title" content="vlan 学习笔记"><meta property="og:url" content="https://ycwu314.cloud/p/linux-network-vlan/index.html"><meta property="og:site_name" content="ycwu314"><meta property="og:description" content="vlan学习笔记"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://ycwu314.cloud/p/linux-network-vlan/v2_hub_switch_router.jpg"><meta property="og:image" content="https://ycwu314.cloud/p/linux-network-vlan/v2_osi_model.png"><meta property="og:image" content="https://ycwu314.cloud/p/linux-network-vlan/v2_network-topology.png"><meta property="og:image" content="https://ycwu314.cloud/p/linux-network-vlan/v2_vlan-trunk-link.jpg"><meta property="og:image" content="https://ycwu314.cloud/p/linux-network-vlan/v2_802_1q.png"><meta property="og:image" content="https://ycwu314.cloud/p/linux-network-vlan/v2_inter-switch-link.jpg"><meta property="og:image" content="https://ycwu314.cloud/p/linux-network-vlan/v2_tagging-protocols.jpg"><meta property="og:image" content="https://ycwu314.cloud/p/linux-network-vlan/v2_router-vlan.png"><meta property="og:image" content="https://ycwu314.cloud/p/linux-network-vlan/v2_Layer-3-Switch-VS-Router.jpg"><meta property="og:updated_time" content="2020-12-24T08:27:14.369Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="vlan 学习笔记"><meta name="twitter:description" content="vlan学习笔记"><meta name="twitter:image" content="https://ycwu314.cloud/p/linux-network-vlan/v2_hub_switch_router.jpg"><link rel="canonical" href="https://ycwu314.cloud/p/linux-network-vlan/"><script id="page.configurations">CONFIG.page={sidebar:""}</script><title>vlan 学习笔记 | ycwu314</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">ycwu314</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">潮的工地</h1></div><div class="site-nav-toggle"><button aria-label="切换导航栏"><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-collection"><a href="/collection" rel="section"><i class="menu-item-icon fa fa-fw fa-file-code-o"></i><br>专题</a></li><li class="menu-item menu-item-tags"><a href="/t/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://ycwu314.cloud/p/linux-network-vlan/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="ycwu314"><meta itemprop="description" content="java, 微服务, 分布式系统, 架构设计"><meta itemprop="image" content="/images/avatar.webp"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="ycwu314"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">vlan 学习笔记</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-06-03 18:10:21" itemprop="dateCreated datePublished" datetime="2020-06-03T18:10:21+08:00">2020-06-03</time> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2020-12-24 16:27:14" itemprop="dateModified" datetime="2020-12-24T16:27:14+08:00">2020-12-24</time> </span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/c/network/" itemprop="url" rel="index"><span itemprop="name">network</span></a></span></span><br><span title="post.wordcount">共&nbsp;3.8k&nbsp;字 <span class="post-meta-divider">|</span> </span><span title="post.min2read">阅读时间&nbsp;13&nbsp;分钟</span><div class="post-description">vlan学习笔记</div></div></header><div class="post-body" itemprop="articleBody"><p style="text-align:center;font-size:14px">本文作者ycwu314，未经允许请勿转载 <a href="https://ycwu314.cloud/p/linux-network-vlan/">vlan 学习笔记</a> : https://ycwu314.cloud/p/linux-network-vlan/<br>&#x6E29;&#x99A8;&#x63D0;&#x793A;&#xFF1A;&#x5982;&#x679C;&#x4E0D;&#x662F;&#x5728;&#x8FD9;&#x4E9B;&#x5730;&#x65B9;&#x770B;&#x5230;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#xFF0C;&#x90A3;&#x4E48;&#x4F60;&#x53EF;&#x80FD;&#x662F;&#x722C;&#x866B;&#x6587;&#x7AE0;&#x7684;&#x53D7;&#x5BB3;&#x8005;&#xFF1A;<br>https://ycwu314.top/ (原https://ycwu314.github.io/)<br>&#x672A;&#x7ECF;&#x6388;&#x6743;&#x7684;&#x8F6C;&#x8F7D;&#xFF0C;&#x4E0D;&#x4EC5;&#x6253;&#x51FB;&#x539F;&#x521B;&#x79EF;&#x6781;&#x6027;&#xFF0C;&#x8FD8;&#x83B7;&#x53D6;&#x4E0D;&#x5230;&#x6700;&#x65B0;&#x7684;&#x6587;&#x7AE0;&#x66F4;&#x65B0;&#x4FE1;&#x606F;&#x3002;</p><p>整理 vlan 学习笔记。</p><a id="more"></a><h1 id="子接口"><a href="# 子接口" class="headerlink" title="子接口"></a>子接口</h1><p>子接口（subinterface）是通过协议和技术将一个物理接口（interface）虚拟出来的多个逻辑接口。对应的物理层接口成为主接口。<br>子接口共用主接口的物理层参数，又可以分别配置各自的链路层和网络层参数。用户可以禁用或者激活子接口，这不会对主接口产生影响；但主接口状态的变化会对子接口产生影响，特别是只有主接口处于连通状态时子接口才能正常工作。</p><p>优点：</p><ul><li>子接口打破了每个设备存在物理接口数量有限的局限性。</li></ul><p>缺点：</p><ul><li>多个子接口共用主接口，性能比单个物理接口差，负载大的情况下容易成为网络流量瓶颈。</li></ul><h1 id="广播，组播，单播"><a href="# 广播，组播，单播" class="headerlink" title="广播，组播，单播"></a>广播，组播，单播</h1><h2 id="广播"><a href="# 广播" class="headerlink" title="广播"></a> 广播</h2><blockquote><p>帧从单一的源发送到共享以太网上的所有主机。广播帧的目的 MAC 地址为十六进制的 FFFFFFFFFFFF，所有收到该广播帧的主机都要接收并处理这个帧。<br>广播方式会产生大量流量，导致带宽利用率降低，进而影响整个网络的性能。</p></blockquote><h2 id="单播"><a href="# 单播" class="headerlink" title="单播"></a>单播</h2><blockquote><p>从单一的源端发送到单一的目的端。每个主机接口由一个 MAC 地址唯一标识，MAC 地址的 OUI 中，第一字节第 8 个比特表示地址类型。对于主机 MAC 地址，这个比特固定为 0，表示目的 MAC 地址为此 MAC 地址的帧都是发送到某个唯一的目的端。<br>在冲突域中，所有主机都能收到源主机发送的单播帧，但是其他主机发现目的地址与本地 MAC 地址不一致后会丢弃收到的帧，只有真正的目的主机才会接收并处理收到的帧。</p></blockquote><h2 id="组播"><a href="# 组播" class="headerlink" title="组播"></a>组播</h2><blockquote><p>组播转发可以理解为选择性的广播，主机侦听特定组播地址，接收并处理目的 MAC 地址为该组播 MAC 地址的帧。<br>组播 MAC 地址和单播 MAC 地址是通过第一字节中的第 8 个比特区分的。组播 MAC 地址的第 8 个比特为 1，而单播 MAC 地址的第 8 个比特为 0。</p></blockquote><h1 id="广播域 -vs- 冲突域"><a href="# 广播域 -vs- 冲突域" class="headerlink" title="广播域 vs 冲突域"></a>广播域 vs 冲突域</h1><p>冲突域：在同一个冲突域中的每一个节点都能收到所有被发送的帧。<br>广播域：网络中能接收任一设备发出的广播帧的所有设备的集合。</p><p><strong>广播域可以跨网段，而冲突域只是发生的同一个网段的 </strong>。</p><p>冲突域：基于第一层（物理层）。<br>广播域：基于第二层（数据链路层）。</p><p>集线器（HUB） 所有端口都在同一个广播域，冲突域内。<br>第二层交换机（Swith）所有端口都在同一个广播域内，而每一个端口就是一个冲突域。</p><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="/p/linux-network-vlan/v2_hub_switch_router.jpg" title="hub vs switch vs router"><h1 id="二层交换机，三层交换机"><a href="# 二层交换机，三层交换机" class="headerlink" title="二层交换机，三层交换机"></a>二层交换机，三层交换机</h1><p>引用参考资料的图片：</p><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="/p/linux-network-vlan/v2_osi_model.png" class="slug" title="osi 模型"><p>二层交换机工作在数据链路层，以太网交换机，依靠 MAC 表（MAC 和以太网端口映射表），交换机会记录每个端口连接的主机的 MAC。当交换机收到主机的数据包，提取目的 MAC 地址，查看目的 MAC 地址的主机连接哪个端口，然后往那个端口发送数据。</p><p>当需要数据流量在 LAN 或 VLAN 之间交换时，则需要使用三层交换机。</p><p>三层交换机工作在网络层，增加路由能力，根据 ip 地址转发；可配置不同 vlan 的 IP 地址，vlan 之间可通过三层路由实现不同 vlan 之间通讯。<br>优势是当同样的数据流再次通过时，将此数据包直接从二层通过，这样减少了因为路由器的路由选择而造成网络的延迟，也可以大大提高转发效率。</p><h1 id="交换机和核心层、汇聚层、接入层"><a href="# 交换机和核心层、汇聚层、接入层" class="headerlink" title="交换机和核心层、汇聚层、接入层"></a>交换机和核心层、汇聚层、接入层</h1><p>图片来源百度百科：</p><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="/p/linux-network-vlan/v2_network-topology.png" title="网络拓扑层次"><blockquote><p>核心层是互连网络的高速主干网，在设计中应增加冗余组件，使其具备高可靠性，能快速适应通信流量的变化。 设计核心层设备的功能时应避免使用数据包过滤、策略路由等降低转发速率的功能特性，使得核心层具有高速率、低延迟和良好的可管理性。 核心层设备覆盖的地理范围不宜过大，连接的设备不宜过多，否则会使得网络的复杂度增大，导致网络性能降低。 核心层应包括一条或多条连接外部网络的专用链路，使得可以高效地访问互联网。</p><p>汇聚层是核心层与接入层之间的分界点，应实现资源访问控制和流量控制等功能。<strong>汇聚层应该对核心层隐藏接入层的详细信息，不管划分了多少个子网，汇聚层向核心路由器发布路由通告时，只通告各个子网汇聚后的超网地址 </strong>。如果局域网中运行了以太网和弹性分组环等不同类型的子网，或者运行了不同路由算法的区域网络，可以通过汇聚层设备完成路由汇总和协议转换功能。</p><p><strong>接入层提供网络接入服务，并解决本地网段内用户之间互相访问的需求 </strong>，要提供足够的带宽，使得本地用户之间可以高速访问； 接入层还应提供一部分管理功能，例如 MAC 地址认证、用户认证、计费管理等； 接入层要负责收集用户信息(例如用户 U 地址、MAC 地址、访问日志等)，作为计费和排错的依据。</p></blockquote><h1 id="vlan"><a href="#vlan" class="headerlink" title="vlan"></a>vlan</h1><h2 id="什么是 vlan"><a href="# 什么是 vlan" class="headerlink" title="什么是 vlan"></a> 什么是 vlan</h2><p>VLAN 所指的 LAN 特指使用路由器分割的网络——也就是广播域。</p><p>VLAN 是现代网络常用的网络虚拟化技术，它可以将物理的二层网络划分成多达 4094 个逻辑网络，这些逻辑网络在二层上是隔离的，每个逻辑网络（即 VLAN）由 VLAN ID 区分，VLAN ID 的取值为 1-4094。<br>受主接口物理性能限制，实际中并无法完全达到 4096 个，数量越多，各子接口性能越差。</p><h2 id="为什么需要 vlan"><a href="# 为什么需要 vlan" class="headerlink" title="为什么需要 vlan"></a>为什么需要 vlan</h2><p>如果整个网络只有一个广播域，那么一旦发出广播信息，就会传遍整个网络，并且对网络中的主机带来额外的负担。因此，在设计 LAN 时，需要注意如何才能有效地分割广播域。<br>二层交换机本来只能构建单一的广播域，不过使用 VLAN 功能后，它能够将网络分割成多个广播域。</p><p>分割广播域时，一般都必须使用到路由器。使用路由器后，可以以路由器上的网络接口 (LAN Interface) 为单位分割广播域。<br>使用路由器分割广播域的话，所能分割的个数完全取决于路由器的网络接口个数。</p><p><strong>VLAN 生成的逻辑上的交换机是互不相通的。因此，在交换机上设置 VLAN 后，如果未做其他处理，VLAN 间是无法通信的 </strong>。</p><h1 id="vlan 分类"><a href="#vlan 分类" class="headerlink" title="vlan 分类"></a>vlan 分类</h1><h2 id="静态 vlan"><a href="# 静态 vlan" class="headerlink" title="静态 vlan"></a> 静态 vlan</h2><p>基于端口的 VLAN(PortBased VLAN)。需要逐个端口指定配置，不适合那些需要频繁改变拓补结构的网络。</p><h2 id="动态 vlan"><a href="# 动态 vlan" class="headerlink" title="动态 vlan"></a>动态 vlan</h2><p>动态 vlan 出发点是灵活配置网络拓扑结构。其细分类型可以对照 OSI 模型。</p><ol><li><p>基于 MAC 地址的 VLAN(MAC Based VLAN)<br>如果计算机交换了网卡，还是需要更改设定。</p></li><li><p>基于子网的 VLAN(Subnet Based VLAN)<br>即使计算机因为交换了网卡或是其他原因导致 MAC 地址改变，只要它的 IP 地址不变，就仍可以加入原先设定的 VLAN。</p></li><li><p>基于用户的 VLAN(User Based VLAN)<br>根据交换机各端口所连的计算机上当前登录的用户，来决定该端口属于哪个 VLAN。这里的用户识别信息，一般是计算机操作系统登录的用户。</p></li></ol><h1 id="vlan 和汇聚链接"><a href="#vlan 和汇聚链接" class="headerlink" title="vlan 和汇聚链接"></a>vlan 和汇聚链接</h1><p>汇聚链接（Trunk Link）指的是能够转发多个不同 VLAN 的通信的端口。</p><p>汇聚链接背景：</p><blockquote><p>在现有网络基础上再新建 VLAN 时，为了让这个 VLAN 能够互通，就需要在交换机间连接新的网线，而建筑物楼层间的纵向布线比较麻烦。并且，VLAN 越多，楼层间（严格地说是交换机间）互联所需的端口也越来越多，交换机端口的利用率低是对资源的一种浪费、也限制了网络的扩展。</p><p>为了避免这种低效率的连接方式，人们想办法让交换机间互联的网线集中到一根上，这时使用的就是 <strong>汇聚链接（Trunk Link）</strong>。</p></blockquote><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="/p/linux-network-vlan/v2_vlan-trunk-link.jpg" class="slug" title="vlan and trunk link"><p>在上面的组网，每个交换机分别处理 2 个 vlan：vlan10 和 vlan20。<br>在没有 vlan trunk link 的情况下，如果要让两个交换机对应的 vlan10 和 vlan20 互通，则两个交换机需要分别占用 2 个端口：</p><ul><li>一个端口用于两侧交换机互通 vlan10</li><li>一个端口用于两侧交换机互通 vlan20</li></ul><p>引入 vlan trunk link 之后，只需要使用一个端口，连同两个交换机即可。<br>汇聚链路上流通的数据帧，都被附加了用于识别分属于哪个 VLAN 的特殊信息。</p><p>对于复杂的组网，vlan 汇聚链接能够减少端口占用、减少布线、更加灵活。</p><p>汇聚链接承载多个 vlan 的通信，负载较重，因此需要带宽更大。<br>默认条件下，汇聚链接会转发交换机上存在的所有 VLAN 的数据。换一个角度看，可以认为汇聚链接 (端口) 同时属于交换机上所有的 VLAN。</p><h1 id="VLAN 的汇聚方式 -——-IEEE802-1Q 与 ISL"><a href="#VLAN 的汇聚方式 -——-IEEE802-1Q 与 ISL" class="headerlink" title="VLAN 的汇聚方式 —— IEEE802.1Q 与 ISL"></a>VLAN 的汇聚方式 —— IEEE802.1Q 与 ISL</h1><p>通过汇聚链路时附加的 VLAN 识别信息，常见的方式有：</p><ul><li>IEEE 802.1Q</li><li>Cisco 产品独有的 ISL(Inter Switch Link)</li></ul><h2 id="802-1q"><a href="#802-1q" class="headerlink" title="802.1q"></a>802.1q</h2><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="/p/linux-network-vlan/v2_802_1q.png" title="802.1q"><p>802.1q 协议在源地址和类型字段之间，增加了 4 个字节标记：</p><ul><li>2 字节的 TPID(Tag Protocol IDentifier)</li><li>2 字节的 TCI(Tag Control Information)</li></ul><p>注意 vlan id 占用 12 bit，最多可供识别 4096 个 VLAN。</p><p>因为 packet 多了 4 个字节，因此要更新末尾的 CRC 字段。</p><p>而当数据帧离开汇聚链路时，TPID 和 TCI 会被去除，这时还会进行一次 CRC 的重新计算。</p><h2 id="cisco-ISL"><a href="#cisco-ISL" class="headerlink" title="cisco ISL"></a>cisco ISL</h2><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="/p/linux-network-vlan/v2_inter-switch-link.jpg" title="cisco ISL"><p>ISL 在数据帧头部增加了 26 字节的 ISL header，在数据帧尾部增加 4 字节的 CRC。总共增加了 30 字节。<br>而当数据帧离开汇聚链路时，直接去掉头部的 ISL header 和尾部的 CRC，原来数据帧的 CRC 不用重新计算。</p><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="/p/linux-network-vlan/v2_tagging-protocols.jpg" title="802.1q vs ISL"><h1 id="路由器和三层交换机"><a href="# 路由器和三层交换机" class="headerlink" title="路由器和三层交换机"></a>路由器和三层交换机</h1><p>非常值得去看 <a href="https://zhuanlan.zhihu.com/p/35616289" rel="external nofollow noopener noreferrer" target="_blank">VLAN 基础知识</a> 当中的 <strong>“VLAN 间路由”</strong> 章节，例子很清晰明了。</p><p>以下内容来源于该文章：</p><blockquote><p>首先，先来复习一下为什么不同 VLAN 间不通过路由就无法通信。在 LAN 内的通信，必须在数据帧头中指定通信目标的 MAC 地址。而为了获取 MAC 地址，TCP/IP 协议下使用的是 ARP。ARP 解析 MAC 地址的方法，则是通过广播。也就是说，如果广播报文无法到达，那么就无从解析 MAC 地址，亦即无法直接通信。</p><p>计算机分属不同的 VLAN，也就意味着分属不同的广播域，自然收不到彼此的广播报文。因此，属于不同 VLAN 的计算机之间无法直接互相通信。为了能够在 VLAN 间通信，需要利用 OSI 参照模型中更高一层——网络层的信息 (IP 地址) 来进行路由。</p></blockquote><p>解决 vlan 间的通信，有多种办法。</p><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="/p/linux-network-vlan/v2_router-vlan.png"><h2 id="使用路由器进行 VLAN 间路由"><a href="# 使用路由器进行 VLAN 间路由" class="headerlink" title="使用路由器进行 VLAN 间路由"></a>使用路由器进行 VLAN 间路由</h2><p>路由器和交换机的接线方式，大致有以下两种：<br>(1)将路由器与交换机上的每个 VLAN 分别连接<br>(2) 不论 VLAN 有多少个，路由器与交换机都只用一条网线连接</p><p>实际上会使用方法 2。实施方案是：</p><blockquote><p>将用于连接路由器的交换机端口设为汇聚链接 (Trunk Link)，而路由器上的端口也必须支持汇聚链路。接着在路由器上定义对应各个 VLAN 的“子接口”(Sub Interface)。尽管实际与交换机连接的物理端口只有一个，但在理论上我们可以把它分割为多个虚拟端口。</p></blockquote><p>收发信双方同属一个 VLAN 之内的通信，一切处理均在交换机内完成。<br>不同 VLAN 间的通信，即使通信双方都连接在同一台交换机上，也必须经过：“发送方——交换机——路由器——交换机——接收方”这样一个流程。</p><p>使用路由器进行 VLAN 间路由时的问题：</p><ul><li>路由器通常基于软件构建，处理数据能力低于基于硬件构建的交换机</li><li>流量会集中到路由器和交换机互联的汇聚链路部分，这一部分尤其特别容易成为速度瓶颈</li></ul><p>于是出现三层交换机：交换模块硬件 + 路由模块硬件，并且二者通过内部高速链接互通。<br>三层交换机则是在内部生成“VLAN 接口”(VLAN Interface)。VLAN 接口，是用于各 VLAN 收发数据的接口。</p><h1 id="加速 VLAN 间通信的手段"><a href="# 加速 VLAN 间通信的手段" class="headerlink" title="加速 VLAN 间通信的手段"></a>加速 VLAN 间通信的手段</h1><p>VLAN 间路由，必须经过外部的路由器或是三层交换机的内置路由模块。但是，有时并不是所有的数据都需要经过路由器(或路由模块)。</p><p>相同的 src ip、src port、dest ip、dest port 的一连串数据包被称为“流”(Flow)。<br>只要将流最初的数据正确地路由以后，后继的数据理应也会被同样地路由。<br>整个流的第一块数据，照常由交换机转发→路由器路由→再次由交换机转发到目标所连端口。这时，将第一块数据路由的结果记录到缓存里保存下来。需要记录的信息有：</p><ul><li>目标 IP 地址</li><li>源 IP 地址</li><li>目标 TCP/UDP 端口号</li><li>源 TCP/UDP 端口号</li><li>接收端口号 (交换机)</li><li>转发端口号 (交换机)</li><li>转发目标 MAC 地址</li></ul><h1 id="路由器和 L3 交换机的对比"><a href="# 路由器和 L3 交换机的对比" class="headerlink" title="路由器和 L3 交换机的对比"></a> 路由器和 L3 交换机的对比</h1><p>路由器的必要性：</p><ol><li>连接 WAN</li><li>网络安全性。路由器除了最基本的数据包过滤功能外，还能基于 IPSec 构建 VPN(VirtualPrivate Network)、利用 RADIUS 进行用户认证等等。</li><li>支持除 TCP/IP 以外的异构网络架构</li></ol><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="/p/linux-network-vlan/v2_Layer-3-Switch-VS-Router.jpg"><h1 id="小结"><a href="# 小结" class="headerlink" title="小结"></a> 小结</h1><p>VLAN 间路由，必须经过外部的路由器或是三层交换机的内置路由模块<br>虽然利用 VLAN 可以灵活地构建网络，但是同时，它也带来了网络结构复杂化的问题。</p><h1 id="参考"><a href="# 参考" class="headerlink" title="参考"></a>参考</h1><ul><li><a href="https://www.cnblogs.com/qishui/p/5428938.html" rel="external nofollow noopener noreferrer" target="_blank">OSI 七层模型与 TCP/IP 五层模型</a></li><li><a href="https://zhuanlan.zhihu.com/p/35616289" rel="external nofollow noopener noreferrer" target="_blank">VLAN 基础知识</a></li></ul><h1>题外话</h1><p style="text-align:center;font-size:14px">&#x672C;&#x6587;&#x4F5C;&#x8005;ycwu314，&#x672A;&#x7ECF;&#x5141;&#x8BB8;&#x8BF7;&#x52FF;&#x8F6C;&#x8F7D; <a href="https://ycwu314.cloud/p/linux-network-vlan/">vlan 学习笔记</a> : https://ycwu314.cloud/p/linux-network-vlan/</p><p style="text-align:center;font-size:16px;font-weight:700">你的支持将鼓励我继续更多原创分享！</p><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="https://s2.ax1x.com/2019/08/12/ezfUk8.jpg" style="width:50%;margin:0 auto"></div><div class="popular-posts-header">相关文章</div><ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><a href="/p/network-arp/" rel="bookmark">arp 协议</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/p/linux-ip-command/" rel="bookmark">linux ip 命令</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/p/linux-veth-tun-tap/" rel="bookmark">linux 网络虚拟化之 veth 和 tun/tap</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/p/linux-bridge/" rel="bookmark">linux bridge 笔记</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/p/network-nat-hairpin/" rel="bookmark">NAT hairpin 模式</a></div></li></ul><div><div id="reward-container"><div>你的支持将鼓励我继续更多原创分享！</div><button id="reward-button" disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">打赏</button><div id="qr" style="display:none"><div style="display:inline-block"><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="https://s2.ax1x.com/2019/08/12/ezfUk8.jpg" alt="ycwu314 微信支付"><p>微信支付</p></div></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者： </strong>ycwu314</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://ycwu314.cloud/p/linux-network-vlan/" title="vlan 学习笔记">https://ycwu314.cloud/p/linux-network-vlan/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均为原创文章，未经允许请勿转载！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/t/network/" rel="tag"># network</a> <a href="/t/vlan/" rel="tag"># vlan</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/p/docker-macvlan-network/" rel="next" title="docker macvlan network 实验"><i class="fa fa-chevron-left"></i> docker macvlan network 实验</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/p/linux-du-df/" rel="prev" title="linux du df 命令">linux du df 命令 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/avatar.webp" alt="ycwu314"><p class="site-author-name" itemprop="name">ycwu314</p><div class="site-description motion-element" itemprop="description">java, 微服务, 分布式系统, 架构设计</div></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/arch"><span class="site-state-item-count">268</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/c/"><span class="site-state-item-count">57</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/t/"><span class="site-state-item-count">99</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/ycwu314" title="GitHub &rarr; https://github.com/ycwu314" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:ycwu314@foxmail.com" title="E-Mail &rarr; mailto:ycwu314@foxmail.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div></div></div><div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#子接口"><span class="nav-number">1.</span> <span class="nav-text">子接口</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#广播，组播，单播"><span class="nav-number">2.</span> <span class="nav-text">广播，组播，单播</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#广播"><span class="nav-number">2.1.</span> <span class="nav-text">广播</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#单播"><span class="nav-number">2.2.</span> <span class="nav-text">单播</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#组播"><span class="nav-number">2.3.</span> <span class="nav-text">组播</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#广播域 -vs- 冲突域"><span class="nav-number">3.</span> <span class="nav-text">广播域 vs 冲突域</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#二层交换机，三层交换机"><span class="nav-number">4.</span> <span class="nav-text">二层交换机，三层交换机</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#交换机和核心层、汇聚层、接入层"><span class="nav-number">5.</span> <span class="nav-text">交换机和核心层、汇聚层、接入层</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#vlan"><span class="nav-number">6.</span> <span class="nav-text">vlan</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#什么是 vlan"><span class="nav-number">6.1.</span> <span class="nav-text">什么是 vlan</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#为什么需要 vlan"><span class="nav-number">6.2.</span> <span class="nav-text">为什么需要 vlan</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#vlan 分类"><span class="nav-number">7.</span> <span class="nav-text">vlan 分类</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#静态 vlan"><span class="nav-number">7.1.</span> <span class="nav-text">静态 vlan</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#动态 vlan"><span class="nav-number">7.2.</span> <span class="nav-text">动态 vlan</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#vlan 和汇聚链接"><span class="nav-number">8.</span> <span class="nav-text">vlan 和汇聚链接</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#VLAN 的汇聚方式 -——-IEEE802-1Q 与 ISL"><span class="nav-number">9.</span> <span class="nav-text">VLAN 的汇聚方式 —— IEEE802.1Q 与 ISL</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#802-1q"><span class="nav-number">9.1.</span> <span class="nav-text">802.1q</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cisco-ISL"><span class="nav-number">9.2.</span> <span class="nav-text">cisco ISL</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#路由器和三层交换机"><span class="nav-number">10.</span> <span class="nav-text">路由器和三层交换机</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#使用路由器进行 VLAN 间路由"><span class="nav-number">10.1.</span> <span class="nav-text">使用路由器进行 VLAN 间路由</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#加速 VLAN 间通信的手段"><span class="nav-number">11.</span> <span class="nav-text">加速 VLAN 间通信的手段</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#路由器和 L3 交换机的对比"><span class="nav-number">12.</span> <span class="nav-text">路由器和 L3 交换机的对比</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#小结"><span class="nav-number">13.</span> <span class="nav-text">小结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考"><span class="nav-number">14.</span> <span class="nav-text">参考</span></a></li></ol></div></div></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2020</span> <span class="with-love" id="animate"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">ycwu314</span> <span class="post-meta-divider">|</span> <span class="post-count">共&nbsp;275.1k&nbsp;字</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/velocity/1.2.1/velocity.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/velocity/1.2.1/velocity.ui.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.6/jquery.fancybox.min.js"></script><script src="/js/utils.js?v=7.1.2"></script><script src="/js/motion.js?v=7.1.2"></script><script src="/js/schemes/muse.js?v=7.1.2"></script><script src="/js/scrollspy.js?v=7.1.2"></script><script src="/js/post-details.js?v=7.1.2"></script><script src="/js/next-boot.js?v=7.1.2"></script><script>function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var e=$("#local-search-input");e.attr("autocapitalize","none"),e.attr("autocorrect","off"),e.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(e){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(e,t,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:e,dataType:isXml?"xml":"json",async:!0,success:function(e){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",e).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():e,r=document.getElementById(t),s=document.getElementById(o),a=function(){var e=r.value.trim().toLowerCase(),t=e.split(/[\s\-]+/);t.length>1&&t.push(e);var o=[];if(e.length>0&&n.forEach(function(n){function r(t,o,n,r){for(var s=r[r.length-1],a=s.position,i=s.word,l=[],h=0;a+i.length<=n&&0!=r.length;){i===e&&h++,l.push({position:a,length:i.length});var p=a+i.length;for(r.pop();0!=r.length&&(s=r[r.length-1],a=s.position,i=s.word,p>a);)r.pop()}return c+=h,{hits:l,start:o,end:n,searchTextCount:h}}function s(e,t){var o="",n=t.start;return t.hits.forEach(function(t){o+=e.substring(n,t.position);var r=t.position+t.length;o+='<b class="search-keyword">'+e.substring(t.position,r)+"</b>",n=r}),o+=e.substring(n,t.end)}var a=!1,i=0,c=0,l=n.title.trim(),h=l.toLowerCase(),p=n.content.trim().replace(/<[^>]+>/g,""),u=p.toLowerCase(),f=decodeURIComponent(n.url).replace(/\/{2,}/g,"/"),d=[],g=[];if(""!=l&&(t.forEach(function(e){function t(e,t,o){var n=e.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(t=t.toLowerCase(),e=e.toLowerCase());(s=t.indexOf(e,r))>-1;)a.push({position:s,word:e}),r=s+n;return a}d=d.concat(t(e,h,!1)),g=g.concat(t(e,u,!1))}),(d.length>0||g.length>0)&&(a=!0,i=d.length+g.length)),a){[d,g].forEach(function(e){e.sort(function(e,t){return t.position!==e.position?t.position-e.position:e.word.length-t.word.length})});var v=[];0!=d.length&&v.push(r(l,0,l.length,d));for(var $=[];0!=g.length;){var C=g[g.length-1],m=C.position,x=C.word,w=m-20,y=m+80;0>w&&(w=0),y<m+x.length&&(y=m+x.length),y>p.length&&(y=p.length),$.push(r(p,w,y,g))}$.sort(function(e,t){return e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hits.length!==t.hits.length?t.hits.length-e.hits.length:e.start-t.start});var T=parseInt("1");T>=0&&($=$.slice(0,T));var b="";b+=0!=v.length?"<li><a href='"+f+"' class='search-result-title'>"+s(l,v[0])+"</a>":"<li><a href='"+f+"' class='search-result-title'>"+l+"</a>",$.forEach(function(e){b+="<a href='"+f+'\'><p class="search-result">'+s(p,e)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:c,hitCount:i,id:o.length})}}),1===t.length&&""===t[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x"></i></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>';else{o.sort(function(e,t){return e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hitCount!==t.hitCount?t.hitCount-e.hitCount:t.id-e.id});var a='<ul class="search-result-list">';o.forEach(function(e){a+=e.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(e){e.stopPropagation(),isfetched===!1?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(e){e.stopPropagation()}),$(document).on("keyup",function(e){var t=27===e.which&&$(".search-popup").is(":visible");t&&onPopupClose()})</script><script>!function(t){function n(){for(var n=0;n<e.length;n++)i=e[n],0<=(o=i.getBoundingClientRect()).top&&0<=o.left&&o.top<=(t.innerHeight||document.documentElement.clientHeight)&&function(){var t,i,o,c,r=e[n];t=r,i=function(){e=e.filter(function(t){return r!==t})},o=new Image,c=t.getAttribute("data-original"),o.onload=function(){t.src=c,i&&i()},o.src=c}();var i,o}var e=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));n(),t.addEventListener("scroll",function(){!function(t,n){clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)}(n,t)})}(this)</script></body></html><!-- rebuild by neat -->