<!-- build time:Thu Dec 24 2020 16:28:33 GMT+0800 (China Standard Time) --><!DOCTYPE html><html class="theme-next mist use-motion" lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="keywords" content="java,微服务,分布式系统,架构设计"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.6/jquery.fancybox.min.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.2/css/font-awesome.min.css"><link rel="stylesheet" href="/css/main.css?v=7.1.2"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.2"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.2"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.2"><link rel="mask-icon" href="/images/logo.svg?v=7.1.2" color="#222"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",version:"7.1.2",sidebar:{position:"left",display:"hide",offset:12,onmobile:!1,dimmer:!1},back2top:!0,back2top_sidebar:!1,fancybox:!0,fastclick:!1,lazyload:!1,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta name="description" content="整理iptables学习笔记。"><meta name="keywords" content="iptables,snat dnat"><meta property="og:type" content="article"><meta property="og:title" content="iptables 笔记"><meta property="og:url" content="https://ycwu314.cloud/p/linux-iptables/index.html"><meta property="og:site_name" content="ycwu314"><meta property="og:description" content="整理iptables学习笔记。"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://ycwu314.cloud/p/linux-iptables/v2_netfilter-traversal.png"><meta property="og:image" content="https://ycwu314.cloud/p/linux-iptables/v2_FW-IDS-iptables-Flowchart-v2019-04-30-1.png"><meta property="og:image" content="https://ycwu314.cloud/p/linux-iptables/v2_iptables.png"><meta property="og:image" content="https://ycwu314.cloud/p/linux-iptables/v2_snat-vs-dnat.png"><meta property="og:image" content="https://ycwu314.cloud/p/linux-iptables/v2_docker-iptables-snat.png"><meta property="og:image" content="https://ycwu314.cloud/p/linux-iptables/v2_docker-iptables-snat-2.png"><meta property="og:updated_time" content="2020-12-24T08:27:14.340Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="iptables 笔记"><meta name="twitter:description" content="整理iptables学习笔记。"><meta name="twitter:image" content="https://ycwu314.cloud/p/linux-iptables/v2_netfilter-traversal.png"><link rel="canonical" href="https://ycwu314.cloud/p/linux-iptables/"><script id="page.configurations">CONFIG.page={sidebar:""}</script><title>iptables 笔记 | ycwu314</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">ycwu314</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">潮的工地</h1></div><div class="site-nav-toggle"><button aria-label="切换导航栏"><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-collection"><a href="/collection" rel="section"><i class="menu-item-icon fa fa-fw fa-file-code-o"></i><br>专题</a></li><li class="menu-item menu-item-tags"><a href="/t/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://ycwu314.cloud/p/linux-iptables/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="ycwu314"><meta itemprop="description" content="java, 微服务, 分布式系统, 架构设计"><meta itemprop="image" content="/images/avatar.webp"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="ycwu314"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">iptables 笔记</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-05-22 11:13:09" itemprop="dateCreated datePublished" datetime="2020-05-22T11:13:09+08:00">2020-05-22</time> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2020-12-24 16:27:14" itemprop="dateModified" datetime="2020-12-24T16:27:14+08:00">2020-12-24</time> </span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/c/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a></span></span><br><span title="post.wordcount">共&nbsp;3.6k&nbsp;字 <span class="post-meta-divider">|</span> </span><span title="post.min2read">阅读时间&nbsp;15&nbsp;分钟</span><div class="post-description">整理iptables学习笔记。</div></div></header><div class="post-body" itemprop="articleBody"><p style="text-align:center;font-size:14px">本文作者ycwu314，未经允许请勿转载 <a href="https://ycwu314.cloud/p/linux-iptables/">iptables 笔记</a> : https://ycwu314.cloud/p/linux-iptables/<br>&#x6E29;&#x99A8;&#x63D0;&#x793A;&#xFF1A;&#x5982;&#x679C;&#x4E0D;&#x662F;&#x5728;&#x8FD9;&#x4E9B;&#x5730;&#x65B9;&#x770B;&#x5230;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#xFF0C;&#x90A3;&#x4E48;&#x4F60;&#x53EF;&#x80FD;&#x662F;&#x722C;&#x866B;&#x6587;&#x7AE0;&#x7684;&#x53D7;&#x5BB3;&#x8005;&#xFF1A;<br>https://ycwu314.top/ (原https://ycwu314.github.io/)<br>&#x672A;&#x7ECF;&#x6388;&#x6743;&#x7684;&#x8F6C;&#x8F7D;&#xFF0C;&#x4E0D;&#x4EC5;&#x6253;&#x51FB;&#x539F;&#x521B;&#x79EF;&#x6781;&#x6027;&#xFF0C;&#x8FD8;&#x83B7;&#x53D6;&#x4E0D;&#x5230;&#x6700;&#x65B0;&#x7684;&#x6587;&#x7AE0;&#x66F4;&#x65B0;&#x4FE1;&#x606F;&#x3002;</p><p>整理 iptables 学习笔记，内容基本复制粘贴自参考资料整理。</p><h1 id="工作流程"><a href="# 工作流程" class="headerlink" title="工作流程"></a>工作流程</h1><p>iptables 能够访问底层的 netfilter 模块。<br>找到一张图，比较精简的阐述 netfilter 处理包的流程：</p><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="/p/linux-iptables/v2_netfilter-traversal.png" title="netfilter-traversal"><a id="more"></a><p>下面这张图就更加详细：</p><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="/p/linux-iptables/v2_FW-IDS-iptables-Flowchart-v2019-04-30-1.png" title="iptables-flowchart"><p>(图片来源：<a href="https://stuffphilwrites.com/2014/09/iptables-processing-flowchart/" rel="external nofollow noopener noreferrer" target="_blank">iptables-processing-flowchart</a>)</p><h1 id="表 -tables"><a href="# 表 -tables" class="headerlink" title="表 tables"></a>表 tables</h1><blockquote><p>raw 表：关闭 nat 表上启用的连接追踪机制；<br>mangle 表：拆解报文，做出修改，并重新封装 的功能；<br>nat 表：network address translation，网络地址转换功能；<br>filter 表：负责过滤功能，防火墙；<br>security 用于强制访问控制网络规则（例如：SELinux )</p></blockquote><p>优先级次序（由高而低）：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">raw --&gt; mangle --&gt; nat --&gt; filter</span><br></pre></td></tr></table></figure></div><p>大部分情况仅需要使用 filter 和 nat。</p><h1 id="链 -chains"><a href="# 链 -chains" class="headerlink" title="链 chains"></a>链 chains</h1><p>链（chains）是数据包传播的路径，每一条链其实就是众多规则中的一个检查清单，每一条链中可以有一条或数条规则。</p><blockquote><p>PREROUTING —— 进入 netfilter 后的数据包在进入路由判断前执行的规则<br>FORWARD —— 经过路由判断后，目的地不是本机的数据包执行的规则。与 nat 和 mangle 表相关联很高，与本机没有关联。<br>INPUT —— 要进入本机的数据包执行的规则<br>OUTPUT —— 由本机产生，需向外发的数据包执行的规则<br>POSTROUTING —— 数据包准备离开 netfilter 时执行的规则</p></blockquote><p>本机路由转发的时候，才配置 FORWARD 转发链。<br>(<code>/proc/sys/net/ipv4/ip_forward</code>，0 表示禁止数据包转发，1 表示允许)</p><p>链的默认规则通常设置为 ACCEPT，如果想确保任何包都不能通过规则集，那么可以重置为 DROP。</p><h1 id="表和链的关系"><a href="# 表和链的关系" class="headerlink" title="表和链的关系"></a>表和链的关系</h1><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">filter</span><br><span class="line">     FORWARD、INPUT、 OUTPUT</span><br><span class="line"></span><br><span class="line">nat</span><br><span class="line">     PREROUTING、POSTROUTING、OUTPUT</span><br><span class="line"></span><br><span class="line">mangle</span><br><span class="line">     PREROUTING、POSTROUTING、OUTPUT、INPUT、FORWARD</span><br><span class="line"></span><br><span class="line">raw</span><br><span class="line">     PREROUTING、OUTPUT</span><br></pre></td></tr></table></figure></div><h1 id="规则 -rules-amp- 目标 -target"><a href="# 规则 -rules-amp- 目标 -target" class="headerlink" title="规则 rules &amp; 目标 target"></a> 规则 rules &amp; 目标 target</h1><p>数据包的过滤基于 <code>规则</code>。规则由一个<code>目标</code>（数据包包匹配所有条件后的动作）和很多匹配（导致该规则可以应用的数据包所满足的条件）指定。</p><p>目标使用 <code>-j</code> 或者 <code>--jump</code> 选项指定。目标可以是用户定义的链（例如，如果条件匹配，跳转到之后的用户定义的链，继续处理）、一个内置的特定目标或者是一个目标扩展。<br><strong>内置目标 </strong>是 <code>ACCEPT</code>， <code>DROP</code>， <code>QUEUE</code> 和 <code>RETURN</code>，<strong>目标扩展 </strong>有 <code>REJECT</code> 、 <code>LOG</code> 等。<br>如果目标是内置目标，数据包的命运会立刻被决定并且在当前表的数据包的处理过程会停止。<br>如果目标是用户定义的链，并且数据包成功穿过第二条链，目标将移动到原始链中的下一个规则。<br>目标扩展可以被终止（像内置目标一样）或者不终止（像用户定义链一样）。</p><p>常见的 target：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">ACCEPT：</span><br><span class="line">允许数据包通过。</span><br><span class="line"></span><br><span class="line">DROP：</span><br><span class="line">直接丢弃数据包，不给任何回应信息，这时候客户端会感觉自己的请求泥牛入海了，过了超时时间才会有反应。</span><br><span class="line"></span><br><span class="line">REJECT：</span><br><span class="line">拒绝数据包通过，必要时会给数据发送端一个响应的信息，客户端刚请求就会收到拒绝的信息。</span><br><span class="line"></span><br><span class="line">LOG：</span><br><span class="line">在 /var/log/messages 文件中记录日志信息，然后将数据包传递给下一条规则。</span><br><span class="line"></span><br><span class="line">REDIRECT：</span><br><span class="line">在本机做端口映射。只适用于 nat 表的 PREROUTING 和 OUTPUT 链，和只调用它们的用户自定义链。</span><br><span class="line"></span><br><span class="line">DNAT：</span><br><span class="line">This target is only valid in the nat table, in the PREROUTING and OUTPUT chains, and user-defined chains which are only called from those chains.</span><br><span class="line"></span><br><span class="line">SNAT：</span><br><span class="line">This target is only valid in the nat table, in the POSTROUTING and INPUT chains, and user-defined chains which are only called from those chains. </span><br><span class="line"></span><br><span class="line">MASQUERADE：</span><br><span class="line">This target is only valid in the nat table, in the POSTROUTING chain. </span><br><span class="line"></span><br><span class="line">RETURN：</span><br><span class="line">在自定义链执行完毕后使用返回，来返回原规则链 </span><br><span class="line"></span><br><span class="line">MARK：</span><br><span class="line"> 增加防火墙标记 </span><br></pre></td></tr></table></figure></div><h1 id="3 种基本路由情况"><a href="#3 种基本路由情况" class="headerlink" title="3 种基本路由情况"></a>3 种基本路由情况</h1><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="/p/linux-iptables/v2_iptables.png" class="slug"><ol><li>入站数据流向</li></ol><p>从外界到达防火墙的数据包，先被 PREROUTING 规则链处理（是否修改数据包地址等），之后会进行路由选择（判断该数据包应该发往何处），如果数据包的目标主机是防火墙本机（比如说 Internet 用户访问防火墙主机中的 web 服务器的数据包），那么内核将其传给 INPUT 链进行处理（决定是否允许通过等），通过以后再交给系统上层的应用程序（比如 Apache 服务器）进行响应。</p><ol start="2"><li>转发数据流向</li></ol><p>来自外界的数据包到达防火墙后，首先被 PREROUTING 规则链处理，之后会进行路由选择，如果数据包的目标地址是其它外部地址（比如局域网用户通过网 关访问 QQ 站点的数据包），则内核将其传递给 FORWARD 链进行处理（是否转发或拦截），然后再交给 POSTROUTING 规则链（是否修改数据包的地 址等）进行处理。</p><ol start="3"><li>出站数据流向</li></ol><p>防火墙本机向外部地址发送的数据包（比如在防火墙主机中测试公网 DNS 服务器时），首先被 OUTPUT 规则链处理，之后进行路由选择，然后传递给 POSTROUTING 规则链（是否修改数据包的地址等）进行处理。</p><h1 id="iptables 命令和例子"><a href="#iptables 命令和例子" class="headerlink" title="iptables 命令和例子"></a>iptables 命令和例子</h1><p>常见参数</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">-P 设置默认策略:iptables -P INPUT (DROP|ACCEPT)</span><br><span class="line">-F 清空规则链</span><br><span class="line">-L 查看规则链</span><br><span class="line">-A 在规则链的末尾加入新规则</span><br><span class="line">-I num 在规则链的头部加入新规则</span><br><span class="line">-D num 删除某一条规则</span><br><span class="line">-s 匹配来源地址 IP/MASK，加叹号 &quot;!&quot; 表示除这个 IP 外。</span><br><span class="line">-d 匹配目标地址</span><br><span class="line">-i 网卡名称 匹配从这块网卡流入的数据</span><br><span class="line">-o 网卡名称 匹配从这块网卡流出的数据</span><br><span class="line">-p 匹配协议, 如 tcp,udp,icmp</span><br><span class="line">--dport num 匹配目标端口号</span><br><span class="line">--sport num 匹配来源端口号</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">    --ipv4	-4		Nothing (line is ignored by ip6tables-restore)</span><br><span class="line">    --ipv6	-6		Error (line is ignored by iptables-restore)</span><br><span class="line">[!] --protocol	-p proto	protocol: by number or name, eg. `tcp&apos;</span><br><span class="line">[!] --source	-s address[/mask][...]</span><br><span class="line">				source specification</span><br><span class="line">[!] --destination   -d address[/mask][...]</span><br><span class="line">				destination specification</span><br><span class="line">[!] --in-interface  -i input name[+]</span><br><span class="line">				network interface name ([+] for wildcard)</span><br><span class="line">--jump    -j target</span><br><span class="line">				target for rule (may load target extension)</span><br><span class="line">--goto    -g chain</span><br><span class="line">                    jump to chain with no return</span><br><span class="line">-match	-m match</span><br><span class="line">				extended match (may load extension)</span><br><span class="line">--numeric	-n		Numeric output.  IP addresses and port numbers will be printed in numeric format.  By default, the program will try to display them as host names, network names, or services (whenever applicable).</span><br><span class="line">[!] --out-interface -o output name[+]</span><br><span class="line">				network interface name ([+] for wildcard)</span><br><span class="line">  --table	-t table	table to manipulate (default: `filter&apos;)</span><br><span class="line">  --verbose	-v		verbose mode</span><br><span class="line">  --wait	-w [seconds]	maximum wait to acquire xtables lock before give up</span><br><span class="line">  --wait-interval -W [usecs]	wait time to try to acquire xtables lock</span><br><span class="line">				default is 1 second</span><br><span class="line">  --line-numbers		print line numbers when listing</span><br><span class="line">  --exact	-x		expand numbers (display exact values)</span><br></pre></td></tr></table></figure></div><p>输出一个链的详情：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -nvL &lt;chain&gt;</span><br></pre></td></tr></table></figure></div><p>iptables match / target 有一堆扩展，参见：<a href="http://ipset.netfilter.org/iptables-extensions.man.html" rel="external nofollow noopener noreferrer" target="_blank">iptables-extensions</a>。 可以简单查看 match / target 的参数：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="SH"><figure class="iseeu highlight /sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@host143 ~]<span class="comment"># iptables -m iprange --help</span></span><br><span class="line"></span><br><span class="line">iprange match options:</span><br><span class="line">[!] --src-range ip[-ip]    Match <span class="built_in">source</span> IP <span class="keyword">in</span> the specified range</span><br><span class="line">[!] --dst-range ip[-ip]    Match destination IP <span class="keyword">in</span> the specified range</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@host143 ~]<span class="comment"># iptables -j DNAT --help</span></span><br><span class="line">DNAT target options:</span><br><span class="line"> --to-destination [&lt;ipaddr&gt;[-&lt;ipaddr&gt;]][:port[-port]]</span><br><span class="line">				Address to map destination to.</span><br><span class="line">[--random] [--persistent]</span><br></pre></td></tr></table></figure></div><p>使用 iptables，要确定操作的 chain、过滤条件（ip、端口、协议）、目标动作。</p><h2 id="前置操作"><a href="# 前置操作" class="headerlink" title="前置操作"></a>前置操作</h2><p>清除所有规则</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tables -F</span><br></pre></td></tr></table></figure></div><p>设置链的默认策略 (默认是 ACCEPT)</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -P FORWARD DROP</span><br></pre></td></tr></table></figure></div><p>保存规则</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables-save &gt; /etc/sysconfig/iptables</span><br></pre></td></tr></table></figure></div><p>或者</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service iptables save</span><br></pre></td></tr></table></figure></div><p>导入 iptables-save 保存的规则</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables-restore &lt; files_saved_by_iptables-save</span><br></pre></td></tr></table></figure></div><h2 id="禁止转发"><a href="# 禁止转发" class="headerlink" title="禁止转发"></a> 禁止转发</h2><p>禁止转发源 IP 地址为 192.168.1.20-192.168.1.99 的 TCP 数据包</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="SH"><figure class="iseeu highlight /sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 因为是“转发”，使用 FORWARD 链</span></span><br><span class="line"><span class="comment"># -A 在某个 chain 后面增加规则</span></span><br><span class="line"><span class="comment"># -p 协议</span></span><br><span class="line"><span class="comment"># -j 跳转目标</span></span><br><span class="line"><span class="comment"># -m match 匹配，iprange 是扩展，支持 --dst-range 和 --src-range</span></span><br><span class="line">iptables -A FORWARD -m iprange --src-range 192.168.0.20-192.168.0.99 -p tcp -j DROP</span><br></pre></td></tr></table></figure></div><p>这里使用了 iptables match 扩展的 <code>iprange</code>。</p><h2 id="MAC 和地址绑定"><a href="#MAC 和地址绑定" class="headerlink" title="MAC 和地址绑定"></a>MAC 和地址绑定</h2><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="SH"><figure class="iseeu highlight /sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables –A FORWARD -s 192.168.30.20 –m mac --mac-source 00:11:5B:EF:7A:D8 -j DROP</span><br></pre></td></tr></table></figure></div><h2 id="阻止某个 ip 入站"><a href="# 阻止某个 ip 入站" class="headerlink" title="阻止某个 ip 入站"></a> 阻止某个 ip 入站</h2><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -s x.x.x.x -j DROP</span><br></pre></td></tr></table></figure></div><h2 id="允许所有外部 http 的连接请求"><a href="# 允许所有外部 http 的连接请求" class="headerlink" title="允许所有外部 http 的连接请求"></a> 允许所有外部 http 的连接请求</h2><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="SH"><figure class="iseeu highlight /sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -i eth0 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT</span><br><span class="line"><span class="comment"># 只对已经建立连接的出站</span></span><br><span class="line"><span class="comment"># 如果是 ftp，则还要增加 RELATED</span></span><br><span class="line">iptables -A OUTPUT -o eth0 -p tcp --sport 80 -m state --state ESTABLISHED -j ACCEPT</span><br></pre></td></tr></table></figure></div><p>这里使用了 match 的 state 模块。为了解决一个安全问题：<strong>怎样判断这些报文是为了回应我们之前发出的报文，还是主动向我们发送的报文呢 </strong>？ (因为发送过来的报文并不总是为了响应我们，也有可能是为了主动攻击我们。)</p><p>state 是 conntrack 模块的子集，支持<code>INVALID, ESTABLISHED, NEW, RELATED or UNTRACKED</code>。</p><blockquote><p>The “state” extension is a subset of the “conntrack” module. “state” allows access to the connection tracking state for this packet.<br>[!] –state state<br>Where state is a comma separated list of the connection states to match. Only a subset of the states unterstood by “conntrack” are recognized: INVALID, ESTABLISHED, NEW, RELATED or UNTRACKED. For their description, see the “conntrack” heading in this manpage.</p></blockquote><p>state 状态如下：</p><ul><li>NEW：连接中的第一个包</li><li>ESTABLISHED：把 NEW 状态包后面的包的状态理解为 ESTABLISHED，表示连接已建立</li><li><strong>RELATED</strong>：正在建立一个新的连接，这个连接是和一个已建立的连接相关的。比如，FTP data transfer，ICMP error 和一个 TCP 或 UDP 连接相关</li><li>INVALID：如果一个包没有办法被识别，或者这个包没有任何状态</li><li>UNTRACKED：当报文的状态为 Untracked 时通常表示无法找到相关的连接。</li></ul><h2 id="multiport 合并多个端口的规则"><a href="#multiport 合并多个端口的规则" class="headerlink" title="multiport 合并多个端口的规则"></a>multiport 合并多个端口的规则</h2><p>match 扩展支持<code>multiport</code>，使用<code>--dports</code> 和<code>--sports</code>。这样多个端口能够合并为一条规则。</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="SH"><figure class="iseeu highlight /sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 允许外部的多个端口访问本机 </span></span><br><span class="line">iptables -A INPUT -i eth0 -p tcp -m multiport --dports 22,80,443 -m state --state NEW,ESTABLISHED -j ACCEPT</span><br><span class="line"></span><br><span class="line">iptables -A OUTPUT -o eth0 -p tcp -m multiport --sports 22,80,443 -m state --state ESTABLISHED -j ACCEPT</span><br></pre></td></tr></table></figure></div><h2 id="允许从本地发起的 HTTPS 连接请求"><a href="# 允许从本地发起的 HTTPS 连接请求" class="headerlink" title="允许从本地发起的 HTTPS 连接请求"></a> 允许从本地发起的 HTTPS 连接请求</h2><p>因为出站规则，先设置 OUPUT 链，对应的连接状态是 NEW、ESTABLISHED。<br>然后设置 INPUT 链，对应的连接状态是 ESTABLISHED。</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -A OUTPUT -o eth0 -p tcp --dport 443 -m state --state NEW,ESTABLISHED -j ACCEPT</span><br><span class="line"></span><br><span class="line">iptables -A INPUT -i eth0 -p tcp --sport 443 -m state --state ESTABLISHED -j ACCEPT</span><br></pre></td></tr></table></figure></div><h2 id="DNAT"><a href="#DNAT" class="headerlink" title="DNAT"></a>DNAT</h2><p>扩展 target。</p><p>防火墙收到来自外网的数据包后，会将该数据包的目的 IP 地址进行替换（源 IP 地址不变），重新转发到内网的主机。</p><blockquote><p>修改目的 ip 地址的原因一般就是为了改变包发送的目的地，让包走出去，而不是留下来，所以在 iptables 中，DNAT 是在入口，也即 PREROUTING 链中发挥作用，以便让包进入 FORWARD 表。</p></blockquote><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="SH"><figure class="iseeu highlight /sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 把所有指向 11.22.33.44 的 http 流量转到 192.168.99.99</span></span><br><span class="line">iptables -t nat -A PREROUTING -d 11.22.33.44 -p tcp --dport 80 -j DNAT --to-destination 192.168.99.99:8080</span><br></pre></td></tr></table></figure></div><p>参数如下：</p><blockquote><p>–to-destination [ipaddr[-ipaddr]][:port[-port]]</p><blockquote><p>which can specify a single new destination IP address, an inclusive range of IP addresses. Optionally a port range, if the rule also specifies one of the following protocols: tcp, udp, dccp or sctp. If no port range is specified, then the destination port will never be modified. If no IP address is specified then only the destination port will be modified. In Kernels up to 2.6.10 you can add several –to-destination options. For those kernels, if you specify more than one destination address, either via an address range or multiple –to-destination options, a simple round-robin (one after another in cycle) load balancing takes place between these addresses. Later Kernels (&gt;= 2.6.11-rc1) don’t have the ability to NAT to multiple ranges anymore.</p></blockquote><p>–random</p><blockquote><p>If option –random is used then port mapping will be randomized (kernel &gt;= 2.6.22).</p></blockquote><p>–persistent</p><blockquote><p>Gives a client the same source-/destination-address for each connection. This supersedes the SAME target. Support for persistent mappings is available from 2.6.29-rc2.</p></blockquote></blockquote><p>作用：</p><ul><li>没有公网 IP 而对外提供服务场景，相当于端口映射</li><li>保护真实主机 ip 的作用</li></ul><h2 id="SNAT"><a href="#SNAT" class="headerlink" title="SNAT"></a>SNAT</h2><p>扩展 target。可以代理上网的功能。</p><p>当内网数据包到达防火墙后，防火墙会使用外部地址替换掉数据包的源 IP 地址（目的 IP 地址不变），使网络内部主机能够与网络外部主机通信。</p><blockquote><p>修改源 ip 地址的目的一般都是为了让这个包能再回到自己这里，所以在 iptables 中，SNAT 是在出口，也即 POSTROUTING 链发挥作用。</p></blockquote><p>假设防火墙两张网卡，一张 eth0 对接外网，ip 为 <code>1.1.1.1</code>。 另一张 eth1，对接内网。内网网段<code>192.168.100.0/24</code> 都使用这个网关访问互联网：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A PREROUTING -s 192.168.100.0/24 -j SNAT --to-source 1.1.1.1</span><br></pre></td></tr></table></figure></div><p>贴一张网上对比 snat 和 dnat 的表格：</p><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="/p/linux-iptables/v2_snat-vs-dnat.png" title="snat 和 dnat 对比"><h2 id="MASQUERADE"><a href="#MASQUERADE" class="headerlink" title="MASQUERADE"></a>MASQUERADE</h2><p>扩展 target。<br>适用于外网 ip 地址非固定的情况。用发送数据的网卡上的 IP 来替换源 IP，因此，对于那些 IP 不固定的场合，比如拨号网络或者通过 dhcp 分配 IP 的情况。</p><p>例如上面 SNAT 的例子，如果 eth0 使用 adsl 方式上网：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A PREROUTING -s 192.168.100.0/24 -j MASQUERADE</span><br></pre></td></tr></table></figure></div><h2 id="端口转发"><a href="# 端口转发" class="headerlink" title="端口转发"></a>端口转发</h2><p>假设对外使用 30022 作为 ssh 端口（默认为 22）</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A PREROUTING -p tcp -d 192.168.100.1 --dport 30022 -j DNAT --to 192.168.100.1:22</span><br><span class="line"></span><br><span class="line">iptables -A INPUT -i eth0 -p tcp --dport 30022 -m state --state NEW,ESTABLISHED -j ACCEPT</span><br><span class="line"></span><br><span class="line">iptables -A OUTPUT -o eth0 -p tcp --sport 30022 -m state --state ESTABLISHED -j ACCEPT</span><br></pre></td></tr></table></figure></div><h2 id="ping 相关"><a href="#ping 相关" class="headerlink" title="ping 相关"></a>ping 相关</h2><p>允许内网 ping 外网</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A OUTPUT -p icmp --icmp-type echo-request -j ACCEPT</span><br><span class="line">iptables -A INPUT -p icmp --icmp-type echo-reply -j ACCEPT</span><br></pre></td></tr></table></figure></div><p>允许外网 ping 内网</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT</span><br><span class="line">iptables -A OUTPUT -p icmp --icmp-type echo-reply -j ACCEPT</span><br></pre></td></tr></table></figure></div><h2 id="负载均衡"><a href="# 负载均衡" class="headerlink" title="负载均衡"></a> 负载均衡</h2><p>把 80 端口的流量负载均衡到 3 台机器上：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="SH"><figure class="iseeu highlight /sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -m nth：使用统计模块，并且是轮询模式，需要指定两个参数：</span></span><br><span class="line"><span class="comment"># --every n：每 n 个 packet 轮询一次 </span></span><br><span class="line"><span class="comment"># --packet p：设置初始化计数</span></span><br><span class="line"><span class="comment"># 从第 p 个包开始，每 n 个包执行该规则</span></span><br><span class="line"></span><br><span class="line">iptables -A PREROUTING -i eth0 -p tcp --dport 80 -m state --state NEW -m nth --counter 0 --every 3 --packet 0 -j DNAT --to-destination 192.168.100.101:8080</span><br><span class="line"></span><br><span class="line">iptables -A PREROUTING -i eth0 -p tcp --dport 80 -m state --state NEW -m nth --counter 0 --every 3 --packet 1 -j DNAT --to-destination 192.168.100.102:8080</span><br><span class="line"></span><br><span class="line">iptables -A PREROUTING -i eth0 -p tcp --dport 80 -m state --state NEW -m nth --counter 0 --every 3 --packet 2 -j DNAT --to-destination 192.168.100.103:8080</span><br></pre></td></tr></table></figure></div><p>这里使用了 statistic 模块。支持两种负载均衡模式：随机和轮询。</p><blockquote><p>–mode mode<br>Set the matching mode of the matching rule, supported modes are random and nth.<br>[!] –probability p<br>Set the probability for a packet to be randomly matched. It only works with the random mode. p must be within 0.0 and 1.0. The supported granularity is in 1/2147483648th increments.<br>[!] –every n<br>Match one packet every nth packet. It works only with the nth mode (see also the –packet option).<br>–packet p<br>Set the initial counter value (0 &lt;= p &lt;= n-1, default 0) for the nth mode.</p></blockquote><h2 id="docker-iptables 使用 snat 访问外网"><a href="#docker-iptables 使用 snat 访问外网" class="headerlink" title="docker iptables 使用 snat 访问外网"></a>docker iptables 使用 snat 访问外网</h2><p>网上看到的图，形象生动：</p><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="/p/linux-iptables/v2_docker-iptables-snat.png"> <img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="/p/linux-iptables/v2_docker-iptables-snat-2.png"><h1 id="参考"><a href="# 参考" class="headerlink" title="参考"></a>参考</h1><ul><li><a href="https://wiki.archlinux.org/index.php/Iptables_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)" rel="external nofollow noopener noreferrer" target="_blank">iptables</a></li><li><a href="https://www.cnblogs.com/metoy/p/4320813.html" rel="external nofollow noopener noreferrer" target="_blank">iptables 详解</a></li><li><a href="https://www.digitalocean.com/community/tutorials/a-deep-dive-into-iptables-and-netfilter-architecture" rel="external nofollow noopener noreferrer" target="_blank">A Deep Dive into Iptables and Netfilter Architecture</a></li><li><a href="https://www.cnblogs.com/bill1015/p/6847841.html" rel="external nofollow noopener noreferrer" target="_blank">25 个 iptables 常用示例</a></li><li><a href="https://tin6150.github.io/psg/firewall.html" rel="external nofollow noopener noreferrer" target="_blank">LINUX FIREWALL</a></li></ul><h1>题外话</h1><p style="text-align:center;font-size:14px">&#x672C;&#x6587;&#x4F5C;&#x8005;ycwu314，&#x672A;&#x7ECF;&#x5141;&#x8BB8;&#x8BF7;&#x52FF;&#x8F6C;&#x8F7D; <a href="https://ycwu314.cloud/p/linux-iptables/">iptables 笔记</a> : https://ycwu314.cloud/p/linux-iptables/</p><p style="text-align:center;font-size:16px;font-weight:700">你的支持将鼓励我继续更多原创分享！</p><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="https://s2.ax1x.com/2019/08/12/ezfUk8.jpg" style="width:50%;margin:0 auto"></div><div class="popular-posts-header">相关文章</div><ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><a href="/p/linux-os-version/" rel="bookmark">linux 查看 os 版本</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/p/linux-kill-zombie-process/" rel="bookmark">处理 zombie 进程</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/p/linux-selinux-intro/" rel="bookmark">selinux 简介</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/p/linux-mem-p4-zoneinfo/" rel="bookmark">linux 内存系列 4：zoneinfo 和水位</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/p/linux-mem-p3-anon-page/" rel="bookmark">linux 内存系列 3：匿名页和内存映射</a></div></li></ul><div><div id="reward-container"><div>你的支持将鼓励我继续更多原创分享！</div><button id="reward-button" disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">打赏</button><div id="qr" style="display:none"><div style="display:inline-block"><img src="https://s2.ax1x.com/2019/09/06/nMx2i4.png" data-original="https://s2.ax1x.com/2019/08/12/ezfUk8.jpg" alt="ycwu314 微信支付"><p>微信支付</p></div></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者： </strong>ycwu314</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://ycwu314.cloud/p/linux-iptables/" title="iptables 笔记">https://ycwu314.cloud/p/linux-iptables/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均为原创文章，未经允许请勿转载！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/t/linux/" rel="tag"># linux</a> <a href="/t/iptables/" rel="tag"># iptables</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/p/linux-firewall-ftp/" rel="next" title="防火墙和 ftp"><i class="fa fa-chevron-left"></i> 防火墙和 ftp</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/p/iptables-docker/" rel="prev" title="iptables docker">iptables docker <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/avatar.webp" alt="ycwu314"><p class="site-author-name" itemprop="name">ycwu314</p><div class="site-description motion-element" itemprop="description">java, 微服务, 分布式系统, 架构设计</div></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/arch"><span class="site-state-item-count">268</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/c/"><span class="site-state-item-count">57</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/t/"><span class="site-state-item-count">99</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/ycwu314" title="GitHub &rarr; https://github.com/ycwu314" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:ycwu314@foxmail.com" title="E-Mail &rarr; mailto:ycwu314@foxmail.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div></div></div><div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#工作流程"><span class="nav-number">1.</span> <span class="nav-text">工作流程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#表 -tables"><span class="nav-number">2.</span> <span class="nav-text">表 tables</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#链 -chains"><span class="nav-number">3.</span> <span class="nav-text">链 chains</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#表和链的关系"><span class="nav-number">4.</span> <span class="nav-text">表和链的关系</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#规则 -rules-amp- 目标 -target"><span class="nav-number">5.</span> <span class="nav-text">规则 rules &amp; 目标 target</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3 种基本路由情况"><span class="nav-number">6.</span> <span class="nav-text">3 种基本路由情况</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#iptables 命令和例子"><span class="nav-number">7.</span> <span class="nav-text">iptables 命令和例子</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#前置操作"><span class="nav-number">7.1.</span> <span class="nav-text">前置操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#禁止转发"><span class="nav-number">7.2.</span> <span class="nav-text">禁止转发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MAC 和地址绑定"><span class="nav-number">7.3.</span> <span class="nav-text">MAC 和地址绑定</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#阻止某个 ip 入站"><span class="nav-number">7.4.</span> <span class="nav-text">阻止某个 ip 入站</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#允许所有外部 http 的连接请求"><span class="nav-number">7.5.</span> <span class="nav-text">允许所有外部 http 的连接请求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#multiport 合并多个端口的规则"><span class="nav-number">7.6.</span> <span class="nav-text">multiport 合并多个端口的规则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#允许从本地发起的 HTTPS 连接请求"><span class="nav-number">7.7.</span> <span class="nav-text">允许从本地发起的 HTTPS 连接请求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DNAT"><span class="nav-number">7.8.</span> <span class="nav-text">DNAT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SNAT"><span class="nav-number">7.9.</span> <span class="nav-text">SNAT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MASQUERADE"><span class="nav-number">7.10.</span> <span class="nav-text">MASQUERADE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#端口转发"><span class="nav-number">7.11.</span> <span class="nav-text">端口转发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ping 相关"><span class="nav-number">7.12.</span> <span class="nav-text">ping 相关</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#负载均衡"><span class="nav-number">7.13.</span> <span class="nav-text">负载均衡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker-iptables 使用 snat 访问外网"><span class="nav-number">7.14.</span> <span class="nav-text">docker iptables 使用 snat 访问外网</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考"><span class="nav-number">8.</span> <span class="nav-text">参考</span></a></li></ol></div></div></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2020</span> <span class="with-love" id="animate"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">ycwu314</span> <span class="post-meta-divider">|</span> <span class="post-count">共&nbsp;275.1k&nbsp;字</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/velocity/1.2.1/velocity.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/velocity/1.2.1/velocity.ui.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.6/jquery.fancybox.min.js"></script><script src="/js/utils.js?v=7.1.2"></script><script src="/js/motion.js?v=7.1.2"></script><script src="/js/schemes/muse.js?v=7.1.2"></script><script src="/js/scrollspy.js?v=7.1.2"></script><script src="/js/post-details.js?v=7.1.2"></script><script src="/js/next-boot.js?v=7.1.2"></script><script>function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var e=$("#local-search-input");e.attr("autocapitalize","none"),e.attr("autocorrect","off"),e.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(e){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(e,t,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:e,dataType:isXml?"xml":"json",async:!0,success:function(e){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",e).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():e,r=document.getElementById(t),s=document.getElementById(o),a=function(){var e=r.value.trim().toLowerCase(),t=e.split(/[\s\-]+/);t.length>1&&t.push(e);var o=[];if(e.length>0&&n.forEach(function(n){function r(t,o,n,r){for(var s=r[r.length-1],a=s.position,i=s.word,l=[],h=0;a+i.length<=n&&0!=r.length;){i===e&&h++,l.push({position:a,length:i.length});var p=a+i.length;for(r.pop();0!=r.length&&(s=r[r.length-1],a=s.position,i=s.word,p>a);)r.pop()}return c+=h,{hits:l,start:o,end:n,searchTextCount:h}}function s(e,t){var o="",n=t.start;return t.hits.forEach(function(t){o+=e.substring(n,t.position);var r=t.position+t.length;o+='<b class="search-keyword">'+e.substring(t.position,r)+"</b>",n=r}),o+=e.substring(n,t.end)}var a=!1,i=0,c=0,l=n.title.trim(),h=l.toLowerCase(),p=n.content.trim().replace(/<[^>]+>/g,""),u=p.toLowerCase(),f=decodeURIComponent(n.url).replace(/\/{2,}/g,"/"),d=[],g=[];if(""!=l&&(t.forEach(function(e){function t(e,t,o){var n=e.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(t=t.toLowerCase(),e=e.toLowerCase());(s=t.indexOf(e,r))>-1;)a.push({position:s,word:e}),r=s+n;return a}d=d.concat(t(e,h,!1)),g=g.concat(t(e,u,!1))}),(d.length>0||g.length>0)&&(a=!0,i=d.length+g.length)),a){[d,g].forEach(function(e){e.sort(function(e,t){return t.position!==e.position?t.position-e.position:e.word.length-t.word.length})});var v=[];0!=d.length&&v.push(r(l,0,l.length,d));for(var $=[];0!=g.length;){var C=g[g.length-1],m=C.position,x=C.word,w=m-20,y=m+80;0>w&&(w=0),y<m+x.length&&(y=m+x.length),y>p.length&&(y=p.length),$.push(r(p,w,y,g))}$.sort(function(e,t){return e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hits.length!==t.hits.length?t.hits.length-e.hits.length:e.start-t.start});var T=parseInt("1");T>=0&&($=$.slice(0,T));var b="";b+=0!=v.length?"<li><a href='"+f+"' class='search-result-title'>"+s(l,v[0])+"</a>":"<li><a href='"+f+"' class='search-result-title'>"+l+"</a>",$.forEach(function(e){b+="<a href='"+f+'\'><p class="search-result">'+s(p,e)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:c,hitCount:i,id:o.length})}}),1===t.length&&""===t[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x"></i></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>';else{o.sort(function(e,t){return e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hitCount!==t.hitCount?t.hitCount-e.hitCount:t.id-e.id});var a='<ul class="search-result-list">';o.forEach(function(e){a+=e.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(e){e.stopPropagation(),isfetched===!1?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(e){e.stopPropagation()}),$(document).on("keyup",function(e){var t=27===e.which&&$(".search-popup").is(":visible");t&&onPopupClose()})</script><script>!function(t){function n(){for(var n=0;n<e.length;n++)i=e[n],0<=(o=i.getBoundingClientRect()).top&&0<=o.left&&o.top<=(t.innerHeight||document.documentElement.clientHeight)&&function(){var t,i,o,c,r=e[n];t=r,i=function(){e=e.filter(function(t){return r!==t})},o=new Image,c=t.getAttribute("data-original"),o.onload=function(){t.src=c,i&&i()},o.src=c}();var i,o}var e=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));n(),t.addEventListener("scroll",function(){!function(t,n){clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)}(n,t)})}(this)</script></body></html><!-- rebuild by neat -->